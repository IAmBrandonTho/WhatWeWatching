(()=>{try{console.log("WW_PATCH_V2");const s=document.createElement("script");s.src="/ffmpeg/ffmpeg.min.js";s.defer=true;s.setAttribute("data-ffmpeg-prewarm","1");document.head.appendChild(s);}catch(e){}})();(()=>{try{const r=new URLSearchParams(location.search).get("room");if(r)fetch("/api/warm?room="+encodeURIComponent(r)).catch(()=>{});}catch(e){}})();window.addEventListener("DOMContentLoaded",()=>{"use strict";const e=e=>document.querySelector(e),t=(e,t)=>{try{return JSON.parse(e)}catch{return t}},n=e("#chatLog"),dbgE=e("#dbgErrors"),dbgL=e("#dbgLog"),r=e("#toast"),o=e("#chatTitle"),a=(e,t,n,r)=>{if(!e){try{i(`Missing element for event: ${t}`,"err")}catch{}return!1}return e.addEventListener(t,n,r),!0};function s(){return(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"})}function i(e,t="t"){const r=document.createElement("div");r.innerHTML=`<span class="t">[${s()}]</span> ${u(e)}`,"sys"===t&&r.classList.add("line-sys"),"me"===t&&r.classList.add("line-me"),"err"===t&&r.classList.add("line-err");const o=("err"===t?dbgE:dbgL)||n;o.appendChild(r),o.scrollTop=o.scrollHeight}function c(e,t,r="t",o=null){const a=document.createElement("div");a.classList.add("chatLine"),o&&(a.dataset.clientId=String(o));const i=document.createElement("span");i.className="t",i.textContent=`[${s()}] `,a.appendChild(i);const c=document.createElement("strong");c.className="chatName",c.textContent=`${String(e||"Friend").trim()}: `,a.appendChild(c);const l=document.createElement("span");l.textContent=String(t??""),a.appendChild(l),"sys"===r&&a.classList.add("line-sys"),"me"===r&&a.classList.add("line-me"),"err"===r&&a.classList.add("line-err"),n.appendChild(a),n.scrollTop=n.scrollHeight}function l(e){r.textContent=e,r.style.display="block",clearTimeout(r._t),r._t=setTimeout(()=>r.style.display="none",1800);try{const t=String(e||"").toLowerCase();t.includes("host is already act")&&setTimeout(()=>{try{nn("viewer")}catch{}},0)}catch{}}function u(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function d(e,t){const n=String(e??"").trim();return n.length>t?n.slice(0,t):n}function m(e,t){const n=String(e??"");return n.length>t?n.slice(0,t):n}async function f(e){try{if(navigator.clipboard?.writeText)await navigator.clipboard.writeText(String(e??""));else{const t=document.createElement("textarea");t.value=String(e??""),t.style.position="fixed",t.style.left="-9999px",document.body.appendChild(t),t.focus(),t.select(),document.execCommand("copy"),t.remove()}l("Copied")}catch(e){i("Clipboard copy failed (try HTTPS): "+(e?.message||e),"err"),l("Copy failed")}}function Dh(e){try{return Array.from((e||document.createElement("div")).children).map(e=>e.textContent||"").join("\n").trim()}catch{return""}}function Hh(e,t){try{const n=new Blob([String(e||"")],{type:"text/plain;charset=utf-8"}),r=document.createElement("a");r.href=URL.createObjectURL(n),r.download=t||"debug.txt",document.body.appendChild(r),r.click(),setTimeout(()=>{try{URL.revokeObjectURL(r.href)}catch{}try{r.remove()}catch{}},0),l("Saved")}catch(e){i("Save failed: "+(e?.message||e),"err"),l("Save failed")}}function Gh(){try{const e=((window.matchMedia&&window.matchMedia("(orientation: portrait)").matches)||window.innerWidth<720),t=document.querySelector("header .topbar"),n=document.querySelector("header .topbar .row");if(!t||!n)return;const r=t.getBoundingClientRect().width,o=n.scrollWidth>r+4||n.getBoundingClientRect().height>44;document.body.classList.toggle("compactStatus",!!(e&&o));const a=document.querySelector("header .brand");if(a){const t=a.getBoundingClientRect().width;const n=t<240||o;document.body.classList.toggle("brandLogoOnly",!!(e&&n))}}catch{}}function p(e){e=Math.max(0,Number(e||0));const t=Math.floor(e/3600),n=Math.floor(e%3600/60),r=Math.floor(e%60),o=String(n).padStart(2,"0"),a=String(r).padStart(2,"0");return t>0?`${t}:${o}:${a}`:`${o}:${a}`}window.addEventListener("error",e=>{try{const t=e&&e.message?String(e.message):"",n=e&&e.filename?String(e.filename):"",r=e&&"number"==typeof e.lineno?e.lineno:null,o=e&&"number"==typeof e.colno?e.colno:null;if("Script error."===t&&!n&&(null===r||0===r))return window.__scriptErrorOnce=window.__scriptErrorOnce||0,void(0===window.__scriptErrorOnce++&&i("JS error: Script error. (Cross-origin script threw or failed to load; open DevTools Console/Network for details.)","err"));i(`JS error: ${t}${n?` @ ${n}:${r??""}:${o??""}`:""}`,"err")}catch{}}),window.addEventListener("unhandledrejection",e=>{try{i(`Promise rejection: ${e.reason?.message||e.reason}`,"err")}catch{}});let h=!1;const y={paused:!0,t:0,rate:1,updatedAt:0};let g=!1;function w(e=!1){if("viewer"!==nt)return;if(g)return;if(Date.now()-(y.updatedAt||0)<8e3){g=!0;try{try{S.playbackRate=y.rate||1}catch{}const tPred=Number.isFinite(y.t)?(y.serverTimeMs?y.t+(Date.now()-y.serverTimeMs)/1e3:y.t):y.t;if(Number.isFinite(tPred)){if(Math.abs((S.currentTime||0)-tPred)>.5)if(Cn?.videoId&&Cn?.segDurMs&&"function"==typeof Cn.rebuildMSE){const e=Math.max(0,Math.floor(1e3*tPred/Cn.segDurMs));Cn.rebuildMSE(e,"host seek")}else try{S.currentTime=tPred}catch{}}if(y.paused)try{S.pause()}catch{}else try{On(tPred??S.currentTime)}catch{}e&&b()}finally{g=!1}}}function v(){if(!ge)return;const e=Number(S.duration||0);if(!isFinite(e)||e<=0)return we&&(we.textContent="--:--"),ve&&(ve.textContent="--:--"),void L(ge);h||(ge.value=String(Math.round(S.currentTime/e*Number(ge.max))),L(ge)),we&&(we.textContent=p(S.currentTime)),ve&&(ve.textContent=p(e));try{__pwRenderSeg()}catch{}}function vH(t,d){if(!ge)return;const e=Number(d||0);if(!isFinite(e)||e<=0)return we&&(we.textContent=p(t||0)),ve&&(ve.textContent="--:--"),void L(ge);h||(ge.value=String(Math.round((Number(t||0))/e*Number(ge.max))),L(ge)),we&&(we.textContent=p(Number(t||0))),ve&&(ve.textContent=p(e));try{__pwRenderSeg()}catch{}}function b(){const e=h;h=!1,v(),h=e}const S=e("#video"),k=new Set([" ","Spacebar","k","K","j","J","l","L","ArrowLeft","ArrowRight","Home","End","0","1","2","3","4","5","6","7","8","9"]);document.addEventListener("keydown",e=>{try{if("viewer"!==nt)return;const _tg=e.target&&e.target.tagName?String(e.target.tagName).toLowerCase():"";if("input"===_tg||"textarea"===_tg||"select"===_tg||e.target?.isContentEditable)return;if(e.ctrlKey||e.metaKey)return;if("F5"===e.key||"F12"===e.key)return;(k.has(e.key)||"Space"===e.code)&&(e.preventDefault(),e.stopPropagation(),w(!0))}catch(t){try{i(`Key handler error: ${t?.message||t}`,"err")}catch{}try{e.preventDefault(),e.stopPropagation()}catch{}}},!0),a(S,"seeking",()=>{"viewer"===nt&&w(!0)},{capture:!0});const x=e=>{"viewer"===nt&&(e.preventDefault(),e.stopPropagation(),w(!0))};function T(){if(!ee)return;const e=!S.paused;ee.classList.toggle("isOn",e),ee.title=e?"Pause (Space)":"Play (Space)",ee.setAttribute("aria-label",e?"Pause":"Play")}function L(e){if(!e)return;const t=Number(e.min||0),n=Number(e.max||100),r=(Number(e.value||0)-t)/(n-t),o=100*Math.max(0,Math.min(1,r));e.style.background=`linear-gradient(90deg, var(--accentA) 0%, var(--accentB) ${o}%, var(--trackBg) ${o}%)`}function M(){const t=`${Number(S.playbackRate||1).toFixed(2)}Ã—`;Se&&(Se.textContent=t);const n=e("#rateLabel2");n&&(n.textContent=t)}function F(){const e=t(localStorage.getItem("peerwatch_prefs")||"{}",{});L(ge),L(ie),M();const n=Number(e.uiScalePct??100);me&&(me.value=String(n)),ye(n,!1),"videoMessagesEnabled"in e&&A(!!e.videoMessagesEnabled,!1),Zt()}["pointerdown","pointerup","mousedown","mouseup","touchstart","touchend","dblclick","contextmenu"].forEach(e=>{S?.addEventListener(e,x,{capture:!0,passive:!1})}),["play","pause","seeking","seeked","ratechange"].forEach(e=>{S?.addEventListener(e,()=>{"viewer"===nt&&(g||w(!0))},{capture:!0})}),a(S,"play",()=>{"viewer"===nt&&w(!0)},{capture:!0}),a(S,"pause",()=>{"viewer"===nt&&w(!0)},{capture:!0}),a(S,"ratechange",()=>{"viewer"===nt&&w(!0)},{capture:!0}),a(S,"contextmenu",e=>{"viewer"===nt&&(e.preventDefault(),e.stopPropagation())},{capture:!0});let $=null;function E(){document.fullscreenElement&&pwControls&&(pwControls.classList.add("show"),clearTimeout($),$=setTimeout(()=>pwControls.classList.remove("show"),2200))}document.addEventListener("fullscreenchange",()=>{document.body.classList.toggle("isFullscreen",!!document.fullscreenElement),document.fullscreenElement?E():pwControls&&pwControls.classList.remove("show")});let P=0,N=null,C=0,D="",I=0;function A(e,t=!0){yt=!!e,pe&&(pe.checked=yt),j&&j.classList.toggle("on",yt),yt||(clearTimeout(N),N=null,B&&B.classList.remove("show"),V&&V.classList.remove("show")),t&&Gt()}function R(){const e=S?.getBoundingClientRect?.(),t=e?.width||U?.clientWidth||0,n=e?.height||U?.clientHeight||0;if(!t||!n)return;const r=Math.max(12,Math.min(72,.02*n)),o=Math.max(6,.03*n),a=Math.max(6,.03*t),s=document.documentElement;s.style.setProperty("--vmFont",r.toFixed(2)+"px"),s.style.setProperty("--vmTop",o.toFixed(2)+"px"),s.style.setProperty("--vmRight",a.toFixed(2)+"px")}function O(e,t){if(!yt)return;const n=Date.now();if(n-C<1e3)return;const r=String(t??"").replace(/\s+/g," ").trim().toLowerCase();if(!r)return;if(r===D&&n-I<1e4)return;C=n,D=r,I=n;const o=`${String(e||"Friend").trim()}: ${String(t??"")}`.trim();if(!o)return;R();if(!B||!V)return;const a=0===P?V:B;(0===P?B:V).classList.remove("show"),a.textContent=o,a.classList.remove("show"),a.offsetWidth,requestAnimationFrame(()=>a.classList.add("show")),P=0===P?1:0,clearTimeout(N),N=setTimeout(()=>{a.classList.remove("show")},5e3)}const U=e("#stage"),_=e("#overlay"),H=e("#subsOverlay"),j=e("#videoMsgOverlay"),B=e("#videoMsgA"),V=e("#videoMsgB"),J=e("#videoMsgComposer"),z=e("#videoMsgComposeInput"),W=e("#videoMsgComposeSend"),G=e("#videoMsgComposeCancel"),K=e("#dropHint"),q=e("#roleLabel"),Y=e("#netDot"),Z=e("#netText"),Q=e("#btnHost"),X=e("#btnViewer"),ee=e("#btnPlayPause"),te=e("#btnStepBack"),ne=e("#btnStepFwd"),re=e("#btnRewind"),oe=e("#btnFwd"),ae=e("#btnSync"),se=e("#btnMute"),ie=e("#vol"),ce=e("#btnVolDown"),le=e("#btnVolUp"),ue=e("#btnRateDown2"),de=e("#btnRateUp2"),me=e("#uiScale"),fe=e("#uiScaleLabel"),pe=e("#videoMsgsToggle"),he=e("#audioSourceSelect"),dbgSave=e("#dbgSaveTxt"),btnCL=e("#btnCopyLogs"),btnCE=e("#btnCopyErrors"),btnCA=e("#btnCopyAll");let pwControls=e("#pwControls");
// Seg availability marks (host: uploaded, viewer: downloaded).
const __pwSegHost=new Set,__pwSegViewer=new Set;
let __pwSegOverlay=null;
function __pwEnsureSegOverlay(){try{if(__pwSegOverlay||!ge)return;const t=ge.parentElement; if(!t)return; const d=document.createElement("div");d.className="segOverlay";t.appendChild(d);__pwSegOverlay=d}catch{}}
function __pwAddSeg(setObj,idx){try{if(!Number.isFinite(idx))return;setObj.add(Number(idx));__pwRenderSeg()}catch{}}
function __pwRanges(setObj){try{const a=Array.from(setObj).filter(e=>Number.isFinite(e)).sort((a,b)=>a-b);if(!a.length)return[];const out=[];let s=a[0],p=a[0];for(let i=1;i<a.length;i++){const v=a[i];if(v===p+1){p=v;continue}out.push([s,p]);s=p=v}out.push([s,p]);return out}catch{return[]}}
function __pwRenderSeg(){try{__pwEnsureSegOverlay();if(!__pwSegOverlay||!ge)return;const dur=Number(S.duration||0);if(!isFinite(dur)||dur<=0){__pwSegOverlay.innerHTML="";return}const segDur=Number((Cn&&Cn.segDurMs)||In||2000)/1000;const useSet=("host"===nt?__pwSegHost:__pwSegViewer);const ranges=__pwRanges(useSet);let html="";for(const [a,b] of ranges){const start=a*segDur;const end=(b+1)*segDur;const l=Math.max(0,start/dur*100);const r=Math.min(100,end/dur*100);if(r<=l)continue;html+=`<span class="seg" style="left:${l}%;width:${r-l}%"></span>`}__pwSegOverlay.innerHTML=html;const bubblePct=(Number(ge.value||0)-Number(ge.min||0))/(Number(ge.max||100)-Number(ge.min||0));const bp=Math.max(0,Math.min(1,bubblePct))*100;__pwSegOverlay.style.clipPath=`inset(0 0 0 ${bp}%)`;}catch{}}
function __pwUpdateTight(){try{if(!pwControls)return;const w=pwControls.getBoundingClientRect().width||0;pwControls.classList.toggle("pwTight",w>0&&w<520)}catch{}}
try{if(pwControls){new ResizeObserver(__pwUpdateTight).observe(pwControls);window.addEventListener("resize",__pwUpdateTight);__pwUpdateTight()}}catch{}
function ye(e,t=!0){const n=Math.max(70,Math.min(160,Number(e)||100));document.documentElement.style.setProperty("--uiScale",String(n/100)),fe&&(fe.textContent=n+"%"),t&&Gt()}a(me,"input",()=>ye(me.value,!0)),a(me,"change",()=>ye(me.value,!0)),a(pe,"change",()=>A(!!pe.checked,!0)),a(he,"change",()=>{const e="external"===he?.value?"external":"video";if(ct=e,Qr(),Xr(),"video"===e)try{!ut&&Number(lt)>0&&(S.muted=!1)}catch{}else try{_e&&_e.src&&(!ut&&Number(lt)>0&&(_e.muted=!1),S.paused||_e.play().catch(()=>{}))}catch{}"host"===nt&&(eo(),Br({type:"audioSrc",mode:ct}))});const ge=e("#seek"),we=e("#timeCur"),ve=e("#timeDur"),be=e("#playerShell"),Se=e("#rateVal"),ke=e("#btnFullscreen"),xe=e("#btnPiP"),Te=e("#displayName"),Le=e("#roomName"),Me=(e("#roomNameRow"),e("#playerTitle")),Fe=e("#themeSel"),$e=e("#themePicker"),Ee=e("#themeBtn"),Pe=e("#themeBtnLabel"),Ne=e("#themeMenu");function Ce(){if(!Pe||!Ne||!Fe)return;const e=Fe.options[Fe.selectedIndex];Pe.textContent=e?e.textContent:Fe.value||"Theme";for(const e of Array.from(Ne.children)){const t=e.dataset.value===Fe.value;e.setAttribute("aria-selected",t?"true":"false")}}function De(){$e&&Ee&&($e.classList.remove("open"),Ee.setAttribute("aria-expanded","false"))}function Ie(){if(!sr||!ir||!rr)return;const e=rr.options[rr.selectedIndex];sr.textContent=e?e.textContent:"Font";for(const e of Array.from(ir.children)){const t=e.dataset.value===rr.value;e.setAttribute("aria-selected",t?"true":"false")}}function Ae(){or&&ar&&(or.classList.remove("open"),ar.setAttribute("aria-expanded","false"))}const Re=e("#btnLoad"),Oe=e("#btnLoadAudio"),Ue=e("#audioPick"),_e=e("#audioEl"),He=e("#btnLoadVtt"),je=e("#btnToggleSubs"),Be=e("#subsTrackSel"),Ve=e("#btnSend"),Je=e("#chatMsg"),ze=e("#btnSnapshot"),We=e("#btnStats"),Ge=e("#btnDisconnect"),Ke=e("#btnShare"),qe=e("#roomCode"),Ye=e("#btnNewRoom"),Ze=e("#joinRoomInput"),Qe=e("#btnJoinRoom");Ze&&(a(Ze,"input",function(){if(!Ze)return;const e=String(Ze.value||""),t=Ze.selectionStart??e.length,n=e.replace(/\D/g,"").slice(0,8),r=n.length>4?n.slice(0,4)+" "+n.slice(4):n,o=e.slice(0,t).replace(/\D/g,"").length,a=o<=4?o:o+1;Ze.value=r;try{Ze.setSelectionRange(a,a)}catch(e){}}),a(Ze,"keydown",e=>{"Enter"===e.key&&(e.preventDefault(),Qe?.click?.())}),a(Ze,"focus",()=>{try{Ze.select()}catch(e){}}));const Xe=e("#filePick"),et=e("#vttPick"),tt=e("#members");if(a(window,"resize",R),a(S,"loadedmetadata",R),a(S,"loadeddata",R),window.ResizeObserver&&U)try{new ResizeObserver(()=>R()).observe(U)}catch(e){}navigator.userAgent.toLowerCase().includes("firefox");let nt=null,rt=null,ot=null,at=null,st=null,it=null;let ct="video",lt=.8,ut=!1,dt=new MediaStream;const mt=[];let ft=null,pt=null,ht=!0,yt=!0;const gt=new Map;let wt=null,vt=null;const bt="peerwatch_session_v2",St="peerwatch_clientId",kt=(()=>{let e=localStorage.getItem(St);return e||(e=(crypto?.randomUUID?.()||"c_"+Math.random().toString(16).slice(2)+Date.now().toString(16)).slice(0,36),localStorage.setItem(St,e)),e})(),xt="www_display_name",Tt=new Map;function Lt(e,t){if(!e)return;const n=d(t,30)||"Friend";Tt.set(String(e),n),document.querySelectorAll(`.chatLine[data-client-id="${String(e)}"] .chatName`).forEach(e=>{e.textContent=`${n}: `})}function Mt(e){return 8===(e=String(e||"").replace(/\D/g,"").slice(0,8)).length?e:""}function Ft(){const e=new URL(location.href).searchParams.get("ws")||"";return e?String(e):""}const $t=document.querySelector('meta[name="signal-url"]')?.getAttribute("content")?.trim(),Et=$t||"wss://whatwewatching-signal.lilbrandon2008.workers.dev",Pt=Ft()||Et;let Nt=null,Ct=!1,Dt=!1,It="",At=null;function Rt(){const e={v:2,at:Date.now(),role:nt||"",roomId:It||"",displayName:d(Te?.value||"",30)||""};localStorage.setItem(bt,JSON.stringify(e))}function Ot(e){Nt&&1===Nt.readyState&&Nt.send(JSON.stringify(e))}function Ut(e,t){if(Dt=!1,It=t||"",It){try{Dt=!0,Nt?.close?.()}catch{}Dt=!1,Nt=new WebSocket(function(e,t){const n=new URL(e.replace(/^ws/i,"http"));return n.searchParams.get("room")||n.searchParams.set("room",t),n.toString().replace(/^http/i,"ws")}(Pt,It)),Ct=!1,Nt.addEventListener("open",()=>{Ct=!0,tn(!0,"Signaling connected"),Ot({type:"hello",v:1,roomId:It,role:e,clientId:kt,name:d(Te?.value||localStorage.getItem(xt)||"",30)||("host"===e?"Host":"Viewer")}),Rt()}),Nt.addEventListener("error",()=>{Ct=!1,tn(!1,"Signaling error")}),Nt.addEventListener("close",e=>{Dt||(Ct=!1,tn(!1,"Disconnected"))}),Nt.addEventListener("message",async e=>{let t;try{t=JSON.parse(e.data)}catch{return}if("welcome"===t.type)return At=t.hostId||At,"viewer"===nt&&At&&(wt=At),i(`Joined room ${It}`,"sys"),Lt(kt,d(Te?.value||localStorage.getItem(xt)||"",30)||("host"===nt?"Host":"Viewer")),void _t(t);if("peerlist"!==t.type)if("room"!==t.type){if("chat"===t.type){if(t.clientId&&String(t.clientId)===String(kt))return;const e=d(t.from||"Friend",30),n=String(t.text??"");return t.clientId&&Lt(t.clientId,e),c(e,n,"t",t.clientId||null),void O(e,n)}if("viewer-join"===t.type&&"host"===nt){const e=String(t.viewerId||"");if(!e)return;return void await no(e,t.name||"Viewer")}if("offer"!==t.type||"viewer"!==nt)if("answer"!==t.type||"host"!==nt){if("peer-left"===t.type){const e=String(t.clientId||"");if(gt.has(e)){try{gt.get(e).pc?.close?.()}catch{}gt.delete(e),Kr()}return}}else await async function(e){try{const t=e||{},n=String(t.peerId||t.from||""),r=gt.get(n);if(!r)return void i("Received answer for unknown peer. Viewer may have reloaded; waiting for rejoinâ€¦","err");await r.pc.setRemoteDescription(t.sdp),t.meta?.name&&(r.name=t.meta.name),Ar?.(),Kr(),i(`Viewer connected: ${r.name||"Viewer"}`,"sys")}catch(e){console.error(e),i("Apply answer failed: "+(e?.message||e),"err")}}(t);else await async function(e){try{const t=e||{};t?.meta?.room&&(Qt=d(t.meta.room,30)||"Room",en(!1));const n=String(t.peerId||t.from||"");if(!n)return;if(gt.has(n)){try{gt.get(n).pc?.close?.()}catch{}gt.delete(n)}const r=qr({asHost:!1,forcedPeerId:n}),{pc:o}=gt.get(r);await o.setRemoteDescription(t.sdp);const a=await o.createAnswer();await o.setLocalDescription(a),await ro(o),Ot({type:"answer",v:1,roomId:It,to:String(t.from||At||""),from:kt,peerId:r,sdp:o.localDescription,meta:{name:d(Te?.value||"",30)||"Viewer"}}),i("Auto-joined host. Sending answerâ€¦","sys"),Kr()}catch(e){console.error(e),i("Auto-join failed: "+(e?.message||e),"err")}}(t)}else"host"!==nt&&(Qt=d(t.name,30)||"Room",en(!1),Xt(Qt));else _t(t)})}}function _t(e){if(!tt)return;tt.innerHTML="";const t=Array.isArray(e.peers)?e.peers:[];for(const e of t){e&&e.id&&Lt(e.id,e.name||("host"===e.role?"Host":"Viewer"));const t=document.createElement("div");t.className="member",t.textContent=("host"===e.role?"ðŸ‘‘ ":"")+(e.name||("host"===e.role?"Host":"Viewer")),tt.appendChild(t)}}const Ht={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302"]}]},jt={hello:"hello",chat:"chat",ctrl:"ctrl",vtt:"vtt",subsStyle:"subsStyle",ping:"ping",pong:"pong",members:"members",hostTaken:"hostTaken"};let Bt=null,Vt=null,Jt=null;function zt(e){document.documentElement.dataset.theme=e||"mono",Wt()}function Wt(){const e=(getComputedStyle(document.documentElement).getPropertyValue("--accent")||"").trim();if(!e)return;const t=function(e){if(!e)return null;const t=String(e).trim();let n=t.match(/^#([0-9a-f]{3})$/i);if(n){const e=n[1];return{r:parseInt(e[0]+e[0],16),g:parseInt(e[1]+e[1],16),b:parseInt(e[2]+e[2],16)}}if(n=t.match(/^#([0-9a-f]{6})$/i),n){const e=n[1];return{r:parseInt(e.slice(0,2),16),g:parseInt(e.slice(2,4),16),b:parseInt(e.slice(4,6),16)}}if(n=t.match(/^rgba?\(([^)]+)\)$/i),n){const e=n[1].split(",").map(e=>e.trim()).filter(Boolean);if(e.length>=3){const t=Number(e[0]),n=Number(e[1]),r=Number(e[2]);if([t,n,r].every(e=>Number.isFinite(e)))return{r:t,g:n,b:r}}}return null}(e)||{r:122,g:162,b:255},n=function(e,t,n){const r=e=>Math.max(0,Math.min(255,Math.round(e)));return{r:r(e.r+(t.r-e.r)*n),g:r(e.g+(t.g-e.g)*n),b:r(e.b+(t.b-e.b)*n)}}(t,{r:255,g:255,b:255},.35);document.documentElement.style.setProperty("--accentA",`rgb(${t.r} ${t.g} ${t.b})`),document.documentElement.style.setProperty("--accentB",`rgb(${n.r} ${n.g} ${n.b})`),document.documentElement.style.setProperty("--accentRGB",`${t.r},${t.g},${t.b}`),document.documentElement.style.setProperty("--accentBRGB",`${n.r},${n.g},${n.b}`),F()}function Gt(){localStorage.setItem("peerwatch_prefs",JSON.stringify({displayName:d(Te.value,30),roomName:d(Le?.value||"",30),theme:Fe.value,vol:Number(ie.value),muted:!!ut,rate:Number(S.playbackRate||1),uiScalePct:Number(me?.value||100),videoMessagesEnabled:!!yt}))}Fe.addEventListener("change",()=>{zt(Fe.value),Gt(),Wt(),l("Theme: "+Fe.value),Ce()}),window.addEventListener("beforeunload",Gt),Te.addEventListener("input",()=>{Te.value=d(Te.value,30),clearTimeout(Te._debounceT),Te._debounceT=setTimeout(()=>{const e=d(Te.value,30)||("host"===nt?"Host":"Viewer");if(localStorage.setItem(xt,e),Lt(kt,e),Ct)try{Nt.send(JSON.stringify({type:"set-name",roomId:It,clientId:kt,name:e}))}catch{}},5e3)}),Le&&(Le.addEventListener("input",()=>{Le.value=m(Le.value,30),en(!1),clearTimeout(Le._debounceT),Le._debounceT=setTimeout(()=>{const e=d(Le.value,30)||"Room";Le.value=e,en(!0),Xt(e),"host"===nt&&Ct&&Ot({type:"room",name:e,roomId:It,clientId:kt}),Gt()},5e3),Gt()}),Le.addEventListener("change",()=>{Le.value=d(Le.value,30);const e=Le.value||"Room";en(!0),Xt(e),"host"===nt&&Ct&&Ot({type:"room",name:e,roomId:It,clientId:kt}),Gt()})),a(Me,"click",()=>{"host"===nt&&Le?.focus()}),ie.addEventListener("input",()=>{if("host"===nt){lt=Number(ie.value),ut=!1,Qr();try{"external"===ct&&_e&&_e.src&&!S.paused&&_e.paused&&_e.play().catch(()=>{})}catch{}L(ie),Zt(),Gt()}else try{ie.value=String(lt),L(ie)}catch(e){}});const Kt=(e,t,n)=>Math.min(n,Math.max(t,e));function qt(e){if("host"!==nt)return;const t=Kt((Number(S.volume)||0)+e,0,1);t>0&&(S.muted=!1),S.volume=t,ie.value=String(t),L(ie),Zt(),Gt()}function Yt(e){const t=Kt(Number(e||1),.25,2),n=.05*Math.round(t/.05);S.playbackRate=Number(n.toFixed(2)),M(),v(),T(),F(),"host"===nt&&Br({type:"rate",rate:S.playbackRate}),Gt()}function Zt(){if(!se)return;const e=!!ut||0===Number(lt);se.classList.toggle("muted",e),se.classList.toggle("isOn",e),se.title=e?"Unmute (M)":"Mute (M)",se.setAttribute("aria-label",e?"Unmute":"Mute")}a(ce,"click",()=>qt(-.05)),a(le,"click",()=>qt(.05)),a(ue,"click",()=>Yt((S.playbackRate||1)-.05)),a(de,"click",()=>Yt((S.playbackRate||1)+.05)),se&&se.addEventListener("click",()=>{ut=!ut,ut||0!==Number(lt)||(lt=.8),Qr(),ie.value=String(lt),L(ie),Zt(),Gt()}),ge&&(ge.addEventListener("input",()=>{h=!0;const e=Number(S.duration||0);if(!isFinite(e)||e<=0)return;const t=Number(ge.value)/Number(ge.max)*e;we&&(we.textContent=p(t)),L(ge),"host"!==nt&&b()}),ge.addEventListener("change",()=>{const e=Number(S.duration||0);if(h=!1,!isFinite(e)||e<=0)return;const t=Number(ge.value)/Number(ge.max)*e;"host"===nt?(S.currentTime=t,Br({type:"seek",t:S.currentTime,paused:S.paused})):b()}));let Qt="Room";function Xt(e){if(!o)return;const t=d(e||"",30);o.textContent=t?`${t} Chat`:"Chat"}function en(e){"host"===nt?(Qt=m(Le?.value||"",30)||"Room",Me&&(Me.textContent=Qt||"Room"),e&&"host"===nt&&Br({type:"room",name:d(Qt,30)||"Room"})):Me&&(Me.textContent=Qt||"Room")}function tn(e,t){const _full=String(t||"");const _l=_full.toLowerCase();let _simple="Disconnected";if(_l.includes("connecting")||_l.includes("reconnect")||_l.includes("opening"))_simple="Connecting";else if(_l.includes("connected")&&!_l.includes("not"))_simple="Connected";else if(_l.includes("connect")&&!_l.includes("not"))_simple="Connecting";Z.textContent=_simple;try{Z.title=_full;Z.parentElement&&(Z.parentElement.title=_full);}catch{}Y.className="dot"+("Connected"===_simple?" ok":"Connecting"===_simple?"":" bad");}function nn(e){const t=nt;if(e===t)return;if("host"===e)for(const[t,n]of gt.entries())if("host"===n?.role){l("A host is already active in this room. You are a Viewer.");return}if("viewer"===e&&!wt)for(const[e,t]of gt.entries())if("host"===t?.role){wt=e;break}"host"===e&&(wt=null),nt=e,document.body.classList.toggle("isHost","host"===nt),q&&(q.textContent="");try{Q?.classList.toggle("activeMode","host"===nt)}catch{}try{X?.classList.toggle("activeMode","viewer"===nt)}catch{};try{Q&&(Q.textContent="Host")}catch{}try{X&&(X.textContent="Viewer")}catch{}K.innerHTML="host"===nt?'Drop a video file here â€¢ You are the <b>Host</b>\n<div class="mini" style="margin-top:6px">Tip: Drop a .vtt subtitles file too</div>':'Waiting for host streamâ€¦\n<div class="mini" style="margin-top:6px">Open a host link to auto-join</div>',ae&&(ae.disabled="host"!==nt),Re&&(Re.disabled="host"!==nt,Re.style.display="host"===nt?"":"none");if([te,ne,re,oe,ge].forEach(e=>e.disabled="viewer"===nt),tn(!1,"Not connected"),"host"===t&&"viewer"===e&&function(){try{S.pause()}catch(e){}if(it){try{URL.revokeObjectURL(it)}catch(e){}it=null}try{S.removeAttribute("src"),S.srcObject=null,S.load()}catch(e){}ot=null,st=null,rt=null}(),co(),"host"===e){!!S.src||!!ot||function(){try{S.pause()}catch{}try{S.currentTime=0}catch{}}()}if(It){try{Nt?.close?.()}catch{}Nt=null,Ct=!1,At=null,Ut(nt,It)}if("viewer"===nt)S.srcObject=null,an(),S.controls=!1,S.autoplay=!0,S.muted=!0,rn(!0);else{S.srcObject=null,S.controls=!1;rn(!(!!S.src||!!ot)),an()}Ar(),Kr()}function rn(e){_.style.display=e?"flex":"none"}function on(e){try{K.style.display=e?"":"none"}catch(e){}}function an(){on(!(!!S.srcObject||!!S.src))}async function sn(e){try{S.paused;try{S.pause()}catch{};try{window.__pwHostHold=!0}catch{}if(it){try{URL.revokeObjectURL(it)}catch{}it=null}try{it=URL.createObjectURL(e);try{S.srcObject=null}catch{}S.src=it,S.playsInline=!0;try{S.load()}catch{}}catch(e){}try{on(!1)}catch{}try{an()}catch{}try{return await bn(),void await async function(e){const t=2e3;In=t,Rn=-1;let n=new Set;const r=t/1e3,o="avc1.42E01E,mp4a.40.2",a="video/mp4",s=Pt.replace(/^ws/i,"http");if(Cn?.stop)try{Cn.stop()}catch{}const c=await async function(e,t){const n="v2",r=Number(e?.size||0),o=Number(e?.lastModified||0),a=String(e?.name||""),s=1048576,i=await e.slice(0,Math.min(s,r)).arrayBuffer(),c=await e.slice(Math.max(0,r-s),r).arrayBuffer(),l=(new TextEncoder).encode(`${n}|${t}|${r}|${o}|${a}`),u=l.byteLength+i.byteLength+c.byteLength,d=new Uint8Array(u);let m=0;d.set(l,m),m+=l.byteLength,d.set(new Uint8Array(i),m),m+=i.byteLength,d.set(new Uint8Array(c),m);const f=await crypto.subtle.digest("SHA-256",d);return Array.from(new Uint8Array(f)).map(e=>e.toString(16).padStart(2,"0")).join("").slice(0,32)}(e,t),l=new URL(s);l.pathname="/seg/init";const u=await fetch(l.toString(),{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({videoId:c,segmentDurationMs:t,mime:a,codecs:o})});if(!u.ok){const e=await u.text().catch(()=>"");throw new Error(`seg/init failed: ${u.status} ${u.statusText} ${e}`)}const{videoId:d}=await u.json();i(`Segmented session created: ${d}`,"sys");try{const e=new URL(s);e.pathname="/seg/meta",e.searchParams.set("videoId",d);const t=await fetch(e.toString(),{cache:"no-store"});if(t.ok){const e=await t.json(),r=Number(e.uploadedSegments||0);Rn=r>0?r-1:e.hasInit?0:-1,n=new Set;for(let e=0;e<r;e++)n.add(e)}}catch(e){}const m=await bn(),f=await Mn(m,e).catch(()=>({})),p=(!f.videoCodec||"h264"===f.videoCodec)&&(!f.audioCodec||"aac"===f.audioCodec),h=Number.isFinite(f.durationSec)&&f.durationSec>0?f.durationSec:isFinite(S.duration)?Number(S.duration):0,y=!p,g=!(!f.width||!f.height)&&(f.width>1920||f.height>1080),w="hevc"===f.videoCodec||"h265"===f.videoCodec,v=f.pixFmt&&f.pixFmt.includes("10");if(y&&(g||w||v)){const e=new Error(`Input is ${f.videoCodec||"unknown"} ${f.width||"?"}x${f.height||"?"} ${f.pixFmt||""}; client-side segmentation would be extremely slow.`);throw e.heavyInput=!0,e.probe=f,e}const b=window.__FFMPEG_FETCHFILE||gn().fetchFile||wn;await Tn(m,"input"),await kn(m,"input",await b(e)),i("Generating init + first segmentsâ€¦","sys");const k={startSeg:0,countSeg:8};let x=p?"copy":"transcode";try{await Fn(m,x,r,k.startSeg,k.countSeg)}catch(e){if("copy"!==x)throw e;i("Stream-copy segmentation failed; transcoding to H.264/AAC (slower, but most compatible).","warn"),x="transcode",await Fn(m,x,r,k.startSeg,k.countSeg)}await async function(e,t,n,r,o){await $n(async()=>{i(`[UPLOAD] init ${r}â€¦`,"sys");const a=await En(n,r,{tries:16,delayMs:60,minBytes:512}),s=new URL(e);s.pathname="/seg/put",s.searchParams.set("videoId",t),s.searchParams.set("kind","init");const c=await fetch(s.toString(),{method:"POST",mode:"cors",headers:{"Content-Type":o||"video/mp4"},body:a});if(!c.ok){const e=await c.text().catch(()=>"");throw new Error(`seg/put init failed: ${c.status} ${c.statusText} ${e}`)}i(`[UPLOAD] init ok (${a.byteLength||a.length} bytes)`,"ok")},{tries:3,baseDelayMs:250})}(s,d,m,"init.mp4",a);const T=[];for(let e=k.startSeg;e<k.startSeg+k.countSeg;e++)T.push(e);await Pn(s,d,m,T,null,{concurrency:4,deleteAfter:!0});const L=o;An=Number(h||0),Dn=d,Br({type:"load-seg",mode:"mse",videoId:d,segmentDurationMs:t,startTime:S.currentTime||0,durationSec:h,playlistUrl:`${cn()}/seg/hls/${d}/out.m3u8`,mime:a,codecs:L});const M=n;for(let e=k.startSeg;e<k.startSeg+k.countSeg;e++)M.add(e);let F=!1,$=-1;const E=new Map;let P=0;const N=268435456,C=(e,t)=>{if(!E.has(e))for(E.set(e,t),P+=t.byteLength||t.length||0;P>N&&E.size>8;){const e=E.keys().next().value,t=E.get(e);E.delete(e),P-=t?.byteLength||t?.length||0}},D=e=>E.get(e)||null,I=e=>{const t=Math.max(0,Math.floor((e||0)/r)),n=Math.ceil(10/r),o=Math.ceil(60/r);return{lo:Math.max(0,t-n),hi:t+o,cur:t}},A=async(e,t)=>{const n=t-e+1;if(n<=0)return;const o=Math.floor((e+t)/2);if(Math.abs(o-$)<=2){let n=0;for(let r=e;r<=t&&(M.has(r)||(n++,!(n>=4)));r++);if(n<4)return}$=o;for(let n=e;n<=t;n++){const e=`seg-${Sn(n)}.m4s`;await Tn(m,e)}await Fn(m,x,r,e,n);const a=[];for(let n=e;n<=t;n++)a.push(n);await Pn(s,d,m,a,M,{concurrency:4,deleteAfter:!0,cachePut:C})},R=async()=>{for(i("Segmented uploader running (priority window: -10s/+60s; upload concurrency: 4; cache: 256MB).","ok");!F;){const e=S.currentTime||0,{lo:t,hi:n,cur:r}=I(e);await A(t,n);const o=[];o.push(r);for(let e=r+1;e<=n;e++)o.push(e);for(let e=r-1;e>=t;e--)o.push(e);const a=[];for(const e of o){if(F)break;if(M.has(e))continue;let t=D(e);if(!t){const n=`seg-${Sn(e)}.m4s`;try{t=await xn(m,n),C(e,t)}catch{continue}}if(a.push({index:e,bytes:t}),a.length>=24)break}if(a.length){await $n(async()=>{await Nn(s,d,a,{concurrency:4,onUploaded:e=>{M.add(e)}})},{tries:3,baseDelayMs:250});for(const e of a){const t=`seg-${Sn(e.index)}.m4s`;await Tn(m,t)}}const i=[];for(let e=n+1;e<n+16&&!F;e++)if(!M.has(e)){await A(e,e+7);for(let t=e;t<=e+7;t++){if(M.has(t))continue;const e=`seg-${Sn(t)}.m4s`;try{const n=await xn(m,e);C(t,n),i.push({index:t,bytes:n})}catch{}if(i.length>=16)break}if(i.length>=16)break}if(i.length){await $n(async()=>{await Nn(s,d,i,{concurrency:4,onUploaded:e=>{M.add(e)}})},{tries:3,baseDelayMs:250});for(const e of i){const t=`seg-${Sn(e.index)}.m4s`;await Tn(m,t)}}await new Promise(e=>setTimeout(e,200))}};R().catch(e=>{console.error(e),i(`Uploader error: ${e?.message||e}`,"err")}),Cn={stop:()=>{F=!0}}}(e)}catch(t){const n=t&&t.message?t.message:String(t);if(t&&t.heavyInput){const n=t.probe||{};return i(`Heavy source detected (${n.videoCodec||"?"} ${n.width||"?"}x${n.height||"?"} ${n.pixFmt||""}). Skipping segmentation and streaming directly via WebRTC captureStream (no progressive seek).`,"warn"),void await hostPlayAndStreamDirect(e)}i(`Segmented mode failed; streaming directly (no progressive seek). Reason: ${n}`,"warn"),await hostPlayAndStreamDirect(e);return}const t=Pt.replace(/^ws/i,"http"),n=new URL(t);n.pathname="/upload",n.search="";const r=await fetch(n.toString(),{method:"POST",body:e,mode:"cors",headers:{"Content-Type":e.type||"video/mp4"}});if(!r.ok){const e=await r.text().catch(()=>"");return i(`Upload failed: ${r.status} ${r.statusText} ${e}`,"err"),void l("Upload failed")}const o=await r.json();if(it=null,S.srcObject=null,S.src=o.url,rn(!1),l("Video uploaded"),Br({type:"load-url",url:o.url}),"host"===nt&&Ke&&(Ke.disabled=!1),i(`Loaded video: ${e.name}`,"sys"),ot=null,eo(),Xr(),"host"===nt){const e=Array.from(gt.entries()).filter(([e,t])=>e&&t&&"viewer"===t.role).map(([e,t])=>({pid:e,name:t.name||"Viewer"}));for(const t of e)await no(t.pid,t.name)}const a=e.name.replace(/\.[^.]+$/,"")+".vtt";try{const e=await fetch(a,{cache:"no-store"});if(e.ok){const t=await e.text();Bn({id:crypto?.randomUUID?crypto.randomUUID().slice(0,8):String(Date.now()),name:a,vtt:t,source:"host",broadcast:!0}),i(`Auto-loaded subtitles: ${a}`,"sys")}}catch(e){}Vr()}catch(e){console.error(e),i("Failed to load video: "+e.message,"err")}}function cn(){return Pt.replace(/^ws/i,"http")}a(Q,"click",()=>nn("host")),a(X,"click",()=>nn("viewer")),a(S,"click",()=>{"viewer"===nt&&(S.muted&&(S.muted=!1,l("Unmuted")),S.play().catch(()=>{}))}),a(U,"dragover",e=>{e.preventDefault(),U.style.outline="2px solid rgba(255,255,255,.35)"}),a(U,"dragleave",()=>{U.style.outline="none"}),a(U,"drop",async e=>{e.preventDefault(),U.style.outline="none";const t=[...e.dataTransfer?.files||[]];if(!t.length)return;const n=t.find(e=>{const t=(e.name||"").toLowerCase();return t.endsWith(".vtt")||t.endsWith(".srt")}),r=t.find(e=>(e.type||"").startsWith("video/"));if(n&&await Jn(n),r){if("host"!==nt)return void l("Only host can load the video");await sn(r)}}),a(K,"click",()=>{"host"===nt&&Xe?.click()}),a(Re,"click",()=>{"host"===nt?Xe?.click():l("Only host can load the video")}),a(Oe,"click",()=>{"host"===nt?Ue?.click():l("Only host can load audio")}),a(U,"dblclick",e=>{0===e.button&&ke?.click()}),a(Xe,"change",async()=>{const e=Xe.files?.[0];if(e)return"host"!==nt?l("Only host can load video"):void await sn(e)}),a(Ue,"change",async()=>{const e=Ue.files?.[0];if(!e)return;if("host"!==nt)return l("Only host can load audio");if(!_e)return void i("Audio element missing.","err");const t=URL.createObjectURL(e);_e.src=t;try{_e.load()}catch{}try{_e.currentTime=S.currentTime||0}catch{}try{_e.playbackRate=S.playbackRate||1}catch{}try{_e.volume=S.volume}catch{}try{_e.muted=S.muted}catch{}_e.captureStream?at=_e.captureStream():(i("Your browser does not support audio.captureStream(); external audio will be local-only.","warn"),at=null),l("Audio loaded"),i(`Loaded audio: ${e.name}`,"sys"),he&&(he.value="external"),ct="external",Xr(),eo(),"host"===nt&&Br({type:"audioSrc",mode:ct})});let ln=null,un=null;const dn="/ffmpeg/ffmpeg-core.js",mn="/ffmpeg/ffmpeg-core.wasm",fn=null,pn=null;function hn(e){return new Promise(t=>setTimeout(t,e))}async function yn(e,t){const n="wasm"===t?["application/wasm","application/octet-stream"]:["application/javascript","text/javascript"];try{const r=await fetch(e,{method:"HEAD",cache:"no-store"}),o=(r.headers.get("content-type")||"").toLowerCase();if(!r.ok)throw new Error(`HTTP ${r.status} ${r.statusText}`);if(o.includes("text/html"))throw new Error(`Got text/html (likely a 404/fallback page), not ${t}`);return o&&!n.some(e=>o.includes(e))&&i(`FFmpeg asset MIME looks wrong for ${t}: ${o} @ ${e}`,"warn"),{ok:!0,ct:o}}catch(r){try{const r=await fetch(e,{method:"GET",headers:{Range:"bytes=0-255"},cache:"no-store"}),o=(r.headers.get("content-type")||"").toLowerCase();if(!r.ok)throw new Error(`HTTP ${r.status} ${r.statusText}`);const a=await r.arrayBuffer(),s=new TextDecoder("utf-8").decode(a).toLowerCase();if(s.includes("<!doctype")||s.includes("<html"))throw new Error(`Got HTML content (likely a 404/fallback page), not ${t}`);if(o&&o.includes("text/html"))throw new Error(`Got text/html (likely a 404/fallback page), not ${t}`);return o&&!n.some(e=>o.includes(e))&&i(`FFmpeg asset MIME looks wrong for ${t}: ${o} @ ${e}`,"warn"),{ok:!0,ct:o}}catch(t){throw new Error(`Asset probe failed for ${e}: ${r?.message||r} / ${t?.message||t}`)}}}function gn(){const e=window,t=e.FFmpegWASM||null,n=e.FFmpeg&&(e.FFmpeg.createFFmpeg||e.FFmpeg.fetchFile)?e.FFmpeg:t&&(t.createFFmpeg||t.fetchFile)?t:null;return{FFmpegClass:t?.FFmpeg||null,createFFmpeg:n?.createFFmpeg||e.createFFmpeg||null,fetchFile:n?.fetchFile||e.fetchFile||null}}async function wn(e){if(e instanceof Uint8Array)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if("string"==typeof e){const t=await fetch(e);if(!t.ok)throw new Error(`fetch failed ${t.status} for ${e}`);const n=(t.headers.get("content-type")||"").toLowerCase(),r=await t.arrayBuffer(),o=(new TextDecoder).decode(r.slice(0,64)).toLowerCase();if(n.includes("text/html")||o.includes("<!doctype")||o.includes("<html"))throw new Error(`Got HTML instead of binary for ${e} (content-type: ${n||"unknown"})`);return new Uint8Array(r)}if(e&&"function"==typeof e.arrayBuffer)return new Uint8Array(await e.arrayBuffer());throw new Error("fetchFileAny: unsupported input")}async function vn(e,t){const{FFmpegClass:n,createFFmpeg:r}=gn();if(await yn(e,"js"),t&&await yn(t,"wasm"),n){const r=new n;try{r.on?.("log",({message:e})=>i(`[FFmpeg] ${e}`,"dim")),r.on?.("progress",e=>{e&&"object"==typeof e&&"ratio"in e&&i(`[FFmpeg] ${(100*e.ratio).toFixed(1)}%`,"dim")})}catch{}return await r.load({coreURL:e,wasmURL:t,workerURL:"/ffmpeg/ffmpeg-core.worker.js"}),window.__FFMPEG_FETCHFILE=wn,r}if(!r)throw new Error("FFmpeg UMD not present (FFmpeg class / createFFmpeg missing). Make sure /ffmpeg/ffmpeg.min.js loads and is not HTML.");const o=r({log:!0,corePath:e});return await o.load(),window.__FFMPEG_FETCHFILE=gn().fetchFile?gn().fetchFile:wn,o}async function bn(){return ln||(un||(un=(async()=>{await async function(){if("host"!==nt)throw new Error("FFmpeg is host-only");window.FFmpegWASM&&window.FFmpegWASM.FFmpeg||await new Promise((e,t)=>{const n=document.createElement("script");n.src="/ffmpeg/ffmpeg.min.js",n.async=!0,n.onload=e,n.onerror=()=>t(new Error("Failed to load /ffmpeg/ffmpeg.min.js")),document.head.appendChild(n)})}();const e=[{core:dn,wasm:mn,label:"primary"},...fn?[{core:fn,wasm:pn,label:"fallback"}]:[]];let t=null;i("Loading FFmpeg.wasm core (first time can download ~30MB)...","warn");for(const n of e)for(let e=0;e<3;e++){const r=250*2**e;try{const e=await vn(n.core,n.wasm);return i(`FFmpeg.wasm loaded (${n.label}).`,"ok"),ln=e,e}catch(o){t=o;const a=o&&o.message?o.message:String(o);i(`FFmpeg load failed (${n.label}, try ${e+1}/3): ${a}`,"err"),e<2&&(i(`Retrying FFmpeg load in ${r}msâ€¦`,"warn"),await hn(r))}}throw i("FFmpeg.wasm failed to load. Progressive seek/segmented upload disabled. See console for details.","err"),console.error("FFmpeg load failure (last error):",t),t||new Error("FFmpeg load failed for unknown reasons.")})(),un))}function Sn(e){return String(e).padStart(6,"0")}async function kn(e,t,n){if(e&&"function"==typeof e.FS)e.FS("writeFile",t,n);else{if(!e||"function"!=typeof e.writeFile)throw new Error("FFmpeg FS writeFile not available");await e.writeFile(t,n)}}async function xn(e,t){if(e&&"function"==typeof e.FS)return e.FS("readFile",t);if(e&&"function"==typeof e.readFile)return await e.readFile(t);throw new Error("FFmpeg FS readFile not available")}async function Tn(e,t){try{if(e&&"function"==typeof e.FS)return void e.FS("unlink",t);if(e&&"function"==typeof e.deleteFile)return void await e.deleteFile(t)}catch{}}async function Ln(e,...t){if(e&&"function"==typeof e.exec)return await e.exec(t);if(e&&"function"==typeof e.run)return await e.run(...t);throw new Error("FFmpeg runner not available (missing exec/run)")}async function Mn(e,t){await Tn(e,"probe"),await kn(e,"probe",await fetchFile(t));let n=[];e.setLogger&&e.setLogger;e.setLogger&&e.setLogger(({type:e,message:t})=>{n.push(String(t||""))});try{try{await Ln(e,"-hide_banner","-nostdin","-i","probe","-f","null","-")}catch{}}finally{e.setLogger&&e.setLogger(({type:e,message:t})=>{}),await Tn(e,"probe")}const r=n.join("\n"),o=/Video:\s*([a-z0-9_]+)/i.exec(r),a=/Audio:\s*([a-z0-9_]+)/i.exec(r),s=/,\s*(\d+)x(\d+)/.exec(r),i=/Video:\s*[a-z0-9_]+[^,]*,\s*([^,\s]+)/i.exec(r);return{videoCodec:o?o[1].toLowerCase():"",audioCodec:a?a[1].toLowerCase():"",width:s?parseInt(s[1],10):0,height:s?parseInt(s[2],10):0,pixFmt:i?i[1].toLowerCase():"",durationSec}}async function Fn(e,t,n,r,o){const a=Math.max(0,r*n),s=Math.max(n,o*n+.1);await Tn(e,"out.m3u8");for(let t=r;t<r+o;t++){const n=`seg-${Sn(t)}.m4s`;await Tn(e,n)}const i=["-hide_banner","-y","-nostdin","-ss",String(a),"-i","input","-t",String(s)],c=["-f","hls","-hls_time",String(n),"-hls_playlist_type","event","-hls_segment_type","fmp4","-hls_fmp4_init_filename","init.mp4","-start_number",String(r),"-hls_segment_filename","seg-%06d.m4s","out.m3u8"];"copy"!==t?await Ln(e,...i,"-vf","scale=w=1280:h=-2:force_original_aspect_ratio=decrease","-c:v","libx264","-preset","ultrafast","-tune","zerolatency","-crf","28","-profile:v","baseline","-level","3.1","-pix_fmt","yuv420p","-maxrate","2500k","-bufsize","5000k","-g",String(Math.max(48,Math.round(2/n*48))),"-c:a","aac","-b:a","128k",...c):await Ln(e,...i,"-c","copy",...c)}async function $n(e,t){const n=Math.max(1,t?.tries||3),r=Math.max(50,t?.baseDelayMs||200);let o=null;for(let t=1;t<=n;t++)try{return await e(t)}catch(e){o=e;const a=r*Math.pow(2,t-1);i(`Retry ${t}/${n} failed: ${e?.message||e}. Waiting ${a}ms...`,"warn"),await new Promise(e=>setTimeout(e,a))}throw o}async function En(e,t,n){const r=Math.max(3,n?.tries||12),o=Math.max(25,n?.delayMs||60),a=Math.max(0,n?.minBytes||0);let s=-1,i=0;for(let n=1;n<=r;n++){try{const n=await xn(e,t),r=n?.byteLength||n?.length||0;if(r>0&&r===s?i++:i=0,s=r,r>0&&i>=2&&r>=a)return n}catch(e){}await new Promise(e=>setTimeout(e,o))}return await xn(e,t)}async function Pn(e,t,n,r,o,a){const s=Math.max(1,Math.min(8,a?.concurrency||4)),c=!!a?.deleteAfter,l="function"==typeof a?.cachePut?a.cachePut:null,u=[];for(const e of r){if(o&&o.has(e))continue;const t=`seg-${Sn(e)}.m4s`;try{const r=await En(n,t,{tries:18,delayMs:60,minBytes:4096});u.push({index:e,bytes:r,name:t}),l&&l(e,r)}catch{}}if(u.length&&(i(`[UPLOAD] ${u.length} segment(s) â†’ /seg/put (concurrency=${s})`,"sys"),await $n(async()=>{await Nn(e,t,u.map(e=>({index:e.index,bytes:e.bytes})),{concurrency:s,onUploaded:e=>{o&&o.add(e);try{Rn=Math.max(Rn,Number(e))}catch{};try{__pwAddSeg(__pwSegHost,Number(e))}catch{}}})},{tries:3,baseDelayMs:250}),i(`[UPLOAD] segments ok: ${u[0].index}..${u[u.length-1].index}`,"ok"),c))for(const e of u)await Tn(n,e.name)}async function Nn(e,t,n,r){const o=Math.max(1,Math.min(8,r?.concurrency||4)),a="function"==typeof r?.onUploaded?r.onUploaded:()=>{};let s=0;const i=Array.from({length:o},()=>(async()=>{for(;;){const r=s++;if(r>=n.length)return;const o=n[r],i=new URL(e);i.pathname="/seg/put",i.searchParams.set("videoId",t),i.searchParams.set("kind","seg"),i.searchParams.set("index",String(o.index));const c=await fetch(i.toString(),{method:"POST",mode:"cors",headers:{"Content-Type":"video/iso.segment"},body:o.bytes});if(!c.ok){const e=await c.text().catch(()=>"");throw new Error(`seg/put index=${o.index} failed: ${c.status} ${c.statusText} ${e}`)}a(o.index)}})());await Promise.all(i)}let Cn=null,Dn=null,In=0,An=0,Rn=-1;async function On(e){if(!(Cn&&Cn.videoId&&Cn.segDurMs)){try{await On(fromSeg*(n/1e3))}catch{}return}const t=Number.isFinite(Number(e))?Number(e):Number(S.currentTime||0),n=Number(Cn.segDurMs||2e3),r=Math.max(0,Math.floor(1e3*t/n)),o=Math.max(1,Math.ceil(5e3/n)+1);if(!On._waiting){On._waiting=!0;try{const e=Number(y?.readyHi??y?.readyHi??-1);let a=Number.isFinite(e)&&e>=r+o-1;if(a||(a=await async function(e,t,n,r){const o=cn(),a=Date.now(),s=Number(r||15e3),i=Math.max(1,Number(n||1)),c=Math.max(0,Number(t||0)),l=async t=>{const n=`${o}/seg/seg/${e}/${t}`;try{let e=await fetch(n,{method:"HEAD",cache:"no-store"});if(405===e.status||501===e.status){e=await fetch(n,{cache:"no-store"});try{e.body?.cancel?.()}catch{}}return e.ok}catch{return!1}};for(;Date.now()-a<s;){let e=!0;for(let t=0;t<i;t++)if(!await l(c+t)){e=!1;break}if(e)return!0;await new Promise(e=>setTimeout(e,250))}return!1}(Cn.videoId,r,o,2e4)),!a)return void i(`[BUF] waiting for segments timed out near seg ${r}`,"warn");try{Math.abs((S.currentTime||0)-t)>.25&&(S.currentTime=t)}catch{}try{await On(fromSeg*(n/1e3))}catch{}}finally{On._waiting=!1}}}async function Un(e){if("host"!==nt){try{await S.play()}catch{}return}if(!Dn||!In){try{await S.play()}catch{}return}const t=Number.isFinite(Number(e))?Number(e):Number(S.currentTime||0),n=Math.max(0,Math.floor(1e3*t/In)),r=Math.max(1,Math.ceil(5e3/In)+1);if(!Un._waiting){Un._waiting=!0;try{const e=Date.now();for(;Date.now()-e<2e4&&!(Rn>=n+r-1);)await new Promise(e=>setTimeout(e,250));if(Rn<n+r-1)return void i(`[BUF] host waiting for upload timed out near seg ${n}`,"warn");try{Math.abs((S.currentTime||0)-t)>.25&&(S.currentTime=t)}catch{}try{await S.play()}catch{}Br({type:"play"}),Vr()}finally{Un._waiting=!1}}}async function _n(e){const t=e?.videoId;if(!t)throw new Error("Missing videoId");const n=Number(e.segmentDurationMs||2e3),r=Number(e.startTime||0),o=String(e.mime||"video/mp4"),a=String(e.codecs||"");if(!a)throw new Error("Missing codecs for MSE init");const s=`${o}; codecs="${a}"`;if(!("MediaSource"in window))throw new Error("MediaSource not supported in this browser");if(!MediaSource.isTypeSupported(s))throw new Error(`Unsupported MIME/codec for MSE: ${s}`);try{Cn?.url&&URL.revokeObjectURL(Cn.url)}catch{}Cn={videoId:t,segDurMs:n,startTime:r,durationSec:Number(e?.durationSec||0),mime:o,codecs:a,mimeCodec:s};const c=cn(),l=new MediaSource,u=URL.createObjectURL(l);Cn.mediaSource=l,Cn.url=u,S.srcObject=null,S.src=u,rn(!1),an(),await new Promise((e,t)=>{l.addEventListener("sourceopen",e,{once:!0}),l.addEventListener("error",()=>t(new Error("MediaSource error")),{once:!0})});const d=Number(e?.durationSec||0);if(Number.isFinite(d)&&d>0)try{l.duration=d}catch{}const m=l.addSourceBuffer(s);Cn.sb=m;const f=e=>new Promise((t,n)=>{const r=Cn?.sb;if(!r)return n(new Error("SourceBuffer missing"));const o=()=>t(),a=()=>n(new Error("SourceBuffer error"));try{r.addEventListener("updateend",o,{once:!0}),r.addEventListener("error",a,{once:!0}),r.appendBuffer(e)}catch(e){n(e)}}),p=e=>{const t=String(e?.message||e||"");return t.includes("SourceBuffer has been removed")||t.includes("removed from the parent media source")||t.includes("InvalidStateError")},h=async(r,o)=>{if(!Cn.rebuilding){Cn.rebuilding=!0;try{i(`[MSE] rebuilding pipeline at seg ${r} (${o||"unknown"})`,"warn");try{Cn?.url&&URL.revokeObjectURL(Cn.url)}catch{}try{S.pause()}catch{}const a=new MediaSource,l=URL.createObjectURL(a);Cn.mediaSource=a,Cn.url=l,S.srcObject=null,S.src=l,await new Promise((e,t)=>{a.addEventListener("sourceopen",e,{once:!0}),a.addEventListener("error",()=>t(new Error("MediaSource error")),{once:!0})});const u=Number(e?.durationSec||0);if(Number.isFinite(u)&&u>0)try{a.duration=u}catch{}const d=a.addSourceBuffer(s);Cn.sb=d;const m=e=>new Promise((t,n)=>{const r=Cn?.sb;if(!r)return n(new Error("SourceBuffer missing"));const o=()=>t(),a=()=>n(new Error("SourceBuffer error"));try{r.addEventListener("updateend",o,{once:!0}),r.addEventListener("error",a,{once:!0}),r.appendBuffer(e)}catch(e){n(e)}}),f=await fetch(`${c}/seg/init/${t}`,{cache:"no-store"});if(!f.ok)throw new Error(`Init missing: ${f.status}`);await m(await f.arrayBuffer()),Cn.nextSeg=Math.max(0,r),Cn._append=m,Cn.seg404=0;try{await On(r*(n/1e3))}catch{}}finally{Cn.rebuilding=!1}}};Cn.rebuildMSE=h;const y=await fetch(`${c}/seg/init/${t}`,{cache:"no-store"});if(!y.ok)throw new Error(`Init missing: ${y.status}`);await(Cn._append||f)(await y.arrayBuffer());const g=Math.max(0,Math.floor(1e3*r/n));Cn.nextSeg=g;S.play().catch(()=>{});try{S.currentTime=r}catch{}(async()=>{const e=Cn.loopToken=Math.random().toString(36).slice(2);for(Cn.seg404=0;Cn&&Cn.videoId===t&&Cn.loopToken===e;){const e=Cn.sb;if(!e){await new Promise(e=>setTimeout(e,50));continue}const n=25,r=S.currentTime||0;if(Hn(r)-r<n&&!e.updating&&!Cn.rebuilding){const e=Cn.nextSeg,n=`${c}/seg/seg/${t}/${e}`;try{const t=await fetch(n,{cache:"no-store"});if(404===t.status){Cn.seg404=Math.min(Cn.seg404+1,30);const e=Math.min(250+200*Cn.seg404,3e3);await new Promise(t=>setTimeout(t,e));continue}if(!t.ok){i(`[MSE] seg ${e} HTTP ${t.status}`,"warn"),await new Promise(e=>setTimeout(e,800));continue}Cn.seg404=0;const r=await t.arrayBuffer();try{const e=Cn._append||f;await e(r),Cn.nextSeg++;try{__pwAddSeg(__pwSegViewer,Number(e))}catch{}}catch(t){const n=String(t?.message||t);if(i(`[MSE] append failed at seg ${e} (${r?.byteLength||0} bytes): ${n}`,"err"),n.includes("still processing")){await new Promise(e=>setTimeout(e,30));continue}p(t)||Cn.mediaSource&&"open"!==Cn.mediaSource.readyState||n.includes("removed from the parent media source")?await h(e,n):await new Promise(e=>setTimeout(e,500))}}catch(t){i(`[MSE] fetch failed seg ${e}: ${t?.message||t}`,"warn"),await new Promise(e=>setTimeout(e,500))}}else await new Promise(e=>setTimeout(e,200))}})()}function Hn(e){try{const t=S.buffered;for(let n=0;n<t.length;n++){const r=t.start(n),o=t.end(n);if(e>=r&&e<=o)return o}return 0}catch{return 0}}function jn(){if(!Be)return;if(!mt.length){Be.innerHTML="";const e=document.createElement("option");return e.value="",e.textContent="No subtitles",Be.appendChild(e),void(Be.value="")}const e=ft;Be.innerHTML="";for(const e of mt){const t=document.createElement("option");t.value=e.id,t.textContent=e.name+("host"===e.source?" (host)":"remote"===e.source?" (shared)":""),Be.appendChild(t)}e&&mt.some(t=>t.id===e)?Be.value=e:Be.value=mt[0].id}function Bn({id:e,name:t,vtt:n,source:r,broadcast:o}){const a={id:e,name:t,vtt:n,source:r||"local"};mt.push(a),ft=e,jn(),Be&&(Be.value=e),Vn(e),o&&"host"===nt&&function(e){if("host"!==nt)return;if(!e?.vtt)return;const t={t:jt.vtt,id:e.id,name:e.name,vtt:e.vtt};for(const e of gt.values())"open"===e.dc?.readyState&&e.dc.send(JSON.stringify(t))}(a)}function Vn(e){const t=mt.find(t=>t.id===e);if(!t)return pt=null,Wn=[],void qn();ft=t.id,async function(e){pt=e||"",Wn=function(e){const t=[];if(!e)return t;const n=String(e).replace(/\r/g,"").split("\n");let r=0;n[r]&&n[r].startsWith("WEBVTT")&&r++;for(;r<n.length;){const e=(n[r]||"").trim();if(!e){r++;continue}let o=e;if(e.includes("--\x3e")||(r++,o=(n[r]||"").trim()),!o.includes("--\x3e")){r++;continue}const[a,s]=o.split("--\x3e").map(e=>e.trim()),i=(s||"").split(/\s+/)[0],c=Kn(a),l=Kn(i);r++;const u=[];for(;r<n.length&&""!==(n[r]||"").trim();)u.push(n[r]),r++;t.push({start:c,end:l,text:u.join("\n")}),r++}return t}(pt);try{for(const e of Array.from(S.querySelectorAll('track[kind="subtitles"], track[kind="captions"]')))e.remove()}catch(e){}for(const e of S.textTracks)e.mode="disabled";qn()}(t.vtt,t.name),Gt()}async function Jn(e){const t=(e.name||"subtitles").trim(),n=t.toLowerCase(),r=await e.text();let o=null;if(n.endsWith(".vtt"))o=r;else{if(!n.endsWith(".srt"))return void l("Unsupported subtitles (use .vtt or .srt)");o=function(e){const t=String.fromCharCode(65279);let n=String(e||"").replace(t,"").trim();n=n.replaceAll("\r\n","\n").replaceAll("\r","\n");const r=n.split("\n"),o=["WEBVTT",""];for(const e of r){const t=e.trim();t&&t.split("").every(e=>e>="0"&&e<="9")||(e.includes("--\x3e")?o.push(e.replaceAll(",",".").replace(/\s+-->\s+/g," --\x3e ")):o.push(e))}return o.join("\n").replace(/\n{3,}/g,"\n\n").trimEnd()+"\n"}(r)}Bn({id:crypto?.randomUUID?crypto.randomUUID().slice(0,8):String(Date.now()),name:t,vtt:o,source:"host"===nt?"host":"local",broadcast:"host"===nt}),i(`Loaded subtitles: ${t}${n.endsWith(".srt")?" (converted from SRT)":""}`,"sys")}function zn(e,t=!1){ht=!!e,je.textContent=ht?"On":"Off";for(const e of S.textTracks)e.mode="disabled";H.classList.toggle("on",ht),t||0,Gt(),0,qn()}a(Be,"change",()=>{const e=Be?.value||"";if(!e)return ft=null,pt=null,Wn=[],void qn();Vn(e),Gt()}),a(He,"click",()=>et?.click()),a(et,"change",async()=>{const e=et.files?.[0];e&&await Jn(e)}),a(je,"click",()=>zn(!ht));let Wn=[],Gn=-1;function Kn(e){const t=e.trim().split(":");let n=0,r=0,o=0;return 3===t.length?(n=parseInt(t[0]||"0",10),r=parseInt(t[1]||"0",10),o=parseFloat(t[2]||"0")):2===t.length?(r=parseInt(t[0]||"0",10),o=parseFloat(t[1]||"0")):o=parseFloat(t[0]||"0"),3600*n+60*r+o}function qn(){if(!ht)return H.innerHTML="",void(Gn=-1);const e=function(e){if(!Wn.length)return-1;if(Gn>=0){const t=Wn[Gn];if(e>=t.start&&e<=t.end)return Gn}for(let t=0;t<Wn.length;t++){const n=Wn[t];if(e>=n.start&&e<=n.end)return t}return-1}((S.currentTime||0)-(Number(Qn.timeOffsetMs)||0)/1e3);if(e===Gn)return;if(Gn=e,H.innerHTML="",e<0)return;const t=Wn[e],n=document.createElement("div");n.className="subsBox";const r=Yn(Qn.topPct,0,45),o=Yn(Qn.leftPct,0,45),a=Yn(Qn.rightPct,0,45),s=Yn(Qn.bottomPct,0,45);n.style.top=r+"%",n.style.left=o+"%",n.style.right=a+"%",n.style.bottom=s+"%";const i=document.createElement("div");var c;i.className="subsText",i.textContent=(c=t.text,String(c||"").replace(/<[^>]*>/g,"")),n.appendChild(i),H.appendChild(n)}function Yn(e,t,n){const r=Number(e);return Number.isNaN(r)?t:Math.min(n,Math.max(t,r))}a(S,"timeupdate",qn),a(S,"seeked",qn),a(S,"ratechange",qn),a(S,"loadedmetadata",qn);const Zn={fontFamily:"system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial",fontSizePct:4,color:"#ffffff",bold:!0,italic:!1,underline:!1,outlineColor:"#000000",outlinePx:2.5,shadowColor:"#000000",shadowPx:4.5,opacityPct:100,bgColor:"#000000",bgOpacityPct:0,padTopPct:0,padRightPct:0,padBottomPct:0,padLeftPct:0,topPct:0,leftPct:5,rightPct:5,bottomPct:8,timeOffsetMs:0},Qn={...Zn};function Xn(){const e=S.getBoundingClientRect?.();return(e&&e.height?e.height:0)||window.innerHeight||720}function er(e){const t=Number(e)||0;return Xn()*t/100}function tr(e){if(e&&"number"==typeof e.fontSize&&null==e.fontSizePct&&(e.fontSizePct=Math.max(.5,Math.min(15,e.fontSize/Xn()*100))),e&&"number"==typeof e.outlineThickness&&null==e.outlinePx&&(e.outlinePx=Math.max(0,Math.min(20,e.outlineThickness))),e&&"number"==typeof e.shadowThickness&&null==e.shadowPx&&(e.shadowPx=Math.max(0,Math.min(30,e.shadowThickness))),e&&"number"==typeof e.paddingPx&&null==e.padTopPct){const t=e.paddingPx/Xn()*100;e.padTopPct=e.padRightPct=e.padBottomPct=e.padLeftPct=Math.max(0,Math.min(5,t))}Object.assign(Qn,e||{});const t=er(Yn(Qn.fontSizePct,.5,15)),n=Yn(Qn.outlinePx,0,20),r=Yn(Qn.shadowPx,0,30),o=er(Yn(Qn.padTopPct,0,5)),a=er(Yn(Qn.padRightPct,0,5)),s=er(Yn(Qn.padBottomPct,0,5)),i=er(Yn(Qn.padLeftPct,0,5));H.style.setProperty("--subs-font",Qn.fontFamily||""),H.style.setProperty("--subs-size",t.toFixed(2)+"px"),H.style.setProperty("--subs-color",Qn.color||"#fff"),H.style.setProperty("--subs-weight",Qn.bold?"800":"500"),H.style.setProperty("--subs-style",Qn.italic?"italic":"normal"),H.style.setProperty("--subs-deco",Qn.underline?"underline":"none"),H.style.setProperty("--subs-opacity",(Yn(Qn.opacityPct,0,100)/100).toFixed(3)),H.style.setProperty("--subs-pad-t",o.toFixed(2)+"px"),H.style.setProperty("--subs-pad-r",a.toFixed(2)+"px"),H.style.setProperty("--subs-pad-b",s.toFixed(2)+"px"),H.style.setProperty("--subs-pad-l",i.toFixed(2)+"px");const c=Yn(Qn.bgOpacityPct,0,100)/100;H.style.setProperty("--subs-bg",c>0?function(e,t){const n=String(e||"").replace("#","").trim();return 6!==n.length?`rgba(0,0,0,${t})`:`rgba(${parseInt(n.slice(0,2),16)},${parseInt(n.slice(2,4),16)},${parseInt(n.slice(4,6),16)},${t})`}(Qn.bgColor||"#000000",c):"transparent"),H.style.setProperty("--subs-shadow",r.toFixed(2)+"px"),H.style.setProperty("--subs-shadow-y",(.35*r).toFixed(2)+"px"),H.style.setProperty("--subs-shadow-color",Qn.shadowColor||"rgba(0,0,0,0)"),H.style.setProperty("--subs-outline-shadow",function(e,t){const n=Math.max(0,Number(t)||0);if(!n)return"0 0 0 rgba(0,0,0,0)";const r=e||"#000";return[`${n}px 0 0 ${r}`,`-${n}px 0 0 ${r}`,`0 ${n}px 0 ${r}`,`0 -${n}px 0 ${r}`,`${n}px ${n}px 0 ${r}`,`${n}px -${n}px 0 ${r}`,`-${n}px ${n}px 0 ${r}`,`-${n}px -${n}px 0 ${r}`].join(", ")}(Qn.outlineColor,n)),qn()}function nr(){if("host"!==nt)return;const e={t:jt.subsStyle,style:Qn};for(const t of gt.values())"open"===t.dc?.readyState&&t.dc.send(JSON.stringify(e))}const rr=e("#subsFontSelect"),or=e("#subsFontPicker"),ar=e("#subsFontBtn"),sr=e("#subsFontBtnLabel"),ir=e("#subsFontMenu"),cr=e("#subsFontCustom"),lr=e("#subsFontSize"),ur=e("#subsBold"),dr=e("#subsItalic"),mr=e("#subsUnderline"),fr=e("#subsColor"),pr=e("#subsColorText"),hr=e("#subsOutlineColor"),yr=e("#subsOutlineThick"),gr=e("#subsShadowColor"),wr=e("#subsShadowThick"),vr=e("#subsOpacity"),br=e("#subsBgOpacity"),Sr=e("#subsBottom"),kr=e("#subsHostHint"),xr=e("#btnSubsApply"),Tr=e("#btnSubsReset"),Lr=e("#subsOffsetLabel"),Mr=e("#btnSubsDelay1000"),Fr=e("#btnSubsDelay100"),$r=e("#btnSubsAdvance100"),Er=e("#btnSubsAdvance1000"),Pr=e("#btnSubsOffsetReset");let Nr={...Qn};function Cr(e,t){e&&(e.value=String(t??""))}function Dr(){if(!rr||!cr)return;const e="custom"===rr.value;cr.style.display=e?"block":"none"}function Ir(){const e=Nr.fontFamily||Zn.fontFamily,t=Array.from(rr.options).some(t=>t.value===e);rr.value=t?e:"custom",Ie(),cr.value=t?"":e,Dr(),Cr(lr,Nr.fontSizePct),ur.checked=!!Nr.bold,dr.checked=!!Nr.italic,mr.checked=!!Nr.underline,Cr(fr,Nr.color),Cr(pr,Nr.color),Cr(hr,Nr.outlineColor),Cr(yr,Nr.outlinePx),Cr(gr,Nr.shadowColor),Cr(wr,Nr.shadowPx),Cr(vr,Nr.opacityPct),Cr(br,Nr.bgOpacityPct),Cr(Sr,Nr.bottomPct),Lr&&(Lr.textContent=String(Number(Nr.timeOffsetMs)||0)+"ms")}function Ar(){const e=!("host"===nt),t=[rr,cr,lr,ur,dr,mr,fr,pr,hr,yr,gr,wr,vr,br,Sr,xr,Tr,Mr,Fr,$r,Er];for(const n of t)n&&(n.disabled=e);kr&&(kr.style.display=e?"block":"none")}function Rr(e){const t=String(e||"").trim();return/^#[0-9a-fA-F]{6}$/.test(t)?t:/^#[0-9a-fA-F]{3}$/.test(t)?"#"+t[1]+t[1]+t[2]+t[2]+t[3]+t[3]:null}function Or(){if("host"!==nt)return;Dr();let e=rr.value;"custom"===e&&(e=cr.value.trim()||Nr.fontFamily||Zn.fontFamily),Nr.fontFamily=e,Nr.fontSizePct=Yn(lr.value,.5,15),Nr.bold=!!ur.checked,Nr.italic=!!dr.checked,Nr.underline=!!mr.checked;const t=Rr(fr.value)||Nr.color;Nr.color=t,pr.value=t;const n=Rr(pr.value);n&&(Nr.color=n,fr.value=n,pr.value=n),Nr.outlineColor=Rr(hr.value)||Nr.outlineColor,Nr.outlinePx=Yn(yr.value,0,20),Nr.shadowColor=Rr(gr.value)||Nr.shadowColor,Nr.shadowPx=Yn(wr.value,0,30),Nr.opacityPct=Yn(vr.value,0,100),Nr.bgOpacityPct=Yn(br.value,0,100),Nr.bottomPct=Yn(Sr.value,0,45),Lr&&(Lr.textContent=String(Number(Nr.timeOffsetMs)||0)+"ms")}function Ur(e){if("host"!==nt)return;const t=Number(Nr.timeOffsetMs)||0;Nr.timeOffsetMs=t+e,Lr&&(Lr.textContent=String(Nr.timeOffsetMs)+"ms"),Gt()}const _r=[rr,cr,lr,ur,dr,mr,fr,pr,hr,yr,gr,wr,vr,br,Sr];for(const e of _r)e&&(a(e,"input",()=>{Or()}),a(e,"change",()=>{Or()}));function Hr(e){if("host"!==nt)return;if(!e||"open"!==e.readyState)return;const t=mt.filter(e=>"host"===e.source);for(const n of t)try{e.send(JSON.stringify({t:jt.vtt,id:n.id,name:n.name,vtt:n.vtt}))}catch{}}a(rr,"change",()=>{Dr(),Ie()}),a(xr,"click",e=>{e.preventDefault(),"host"===nt&&(Or(),Object.assign(Qn,Nr),tr(Qn),jn(),nr(),Gt())}),a(Tr,"click",e=>{e.preventDefault(),"host"===nt&&(Nr={...Zn},Ir(),Object.assign(Qn,Nr),tr(Qn),nr(),Gt())}),a(Mr,"click",e=>{e.preventDefault(),Ur(1e3)}),a(Fr,"click",e=>{e.preventDefault(),Ur(100)}),a($r,"click",e=>{e.preventDefault(),Ur(-100)}),a(Er,"click",e=>{e.preventDefault(),Ur(-1e3)}),a(Pr,"click",e=>{e.preventDefault(),"host"===nt&&(Nr.timeOffsetMs=0,Lr&&(Lr.textContent="0ms"),Gt())}),Nr={...Qn},Ir(),tr(Qn),window.addEventListener("resize",()=>tr(Qn)),document.addEventListener("fullscreenchange",()=>tr(Qn)),jn();let jr=null;function Br(e){if("host"!==nt)return;!e||"load-seg"!==e.type&&"load-url"!==e.type||(jr=e);const t={t:jt.ctrl,at:Date.now(),payload:e};for(const e of gt.values())"open"===e.dc?.readyState&&e.dc.send(JSON.stringify(t))}function Vr(){"host"===nt&&Br({type:"state",paused:S.paused,t:S.currentTime,seg:In?Math.max(0,Math.floor(1e3*(S.currentTime||0)/In)):void 0,readyHi:Number.isFinite(Rn)?Rn:-1,segDurMs:In||void 0,durationSec:An||void 0,rate:S.playbackRate,subs:ht})}function Jr(e){if("host"===nt&&window.__pwHostHold){l("Waiting for initial 5s uploadâ€¦");return}S.currentTime=Math.max(0,S.currentTime+e),Br({type:"seek",t:S.currentTime})}function zr(e){if("host"===nt&&window.__pwHostHold){l("Waiting for initial 5s uploadâ€¦");return}S.pause(),S.currentTime=Math.max(0,S.currentTime+e*(1/30)),Br({type:"seek",t:S.currentTime,paused:!0})}ee.addEventListener("click",async()=>{"host"===nt?S.paused?await Un(S.currentTime||0):(S.pause(),Br({type:"pause"})):w(!0)}),a(S,"click",e=>{"host"===nt&&(e.preventDefault(),ee?.click())}),re.addEventListener("click",()=>Jr(-10)),oe.addEventListener("click",()=>Jr(10)),te.addEventListener("click",()=>zr(-1)),ne.addEventListener("click",()=>zr(1)),ae.addEventListener("click",()=>Vr());let Wr=null;function Gr(e){const t=document.createElement("div");t.className="member",t.textContent=e,tt.appendChild(t)}function Kr(){tt.innerHTML="";const e=d(Te.value,30)||("host"===nt?"Host":"Viewer");"host"===nt?Gr(`ðŸ‘‘ ${e} (you)`):"viewer"===nt&&Gr(`${e} (you)`);for(const e of gt.values()){const t=e.name||("host"===e.role?"Host":"Viewer");"host"===e.role?Gr(`ðŸ‘‘ ${t}`):Gr(t)}}function qr({asHost:e,forcedPeerId:t=null}){const n=t||crypto.randomUUID().slice(0,8),r=new RTCPeerConnection(Ht);gt.set(n,{pc:r,dc:null,name:null});let o=null;if(e){const e=r.addTransceiver("video",{direction:"sendonly"}),t=r.addTransceiver("audio",{direction:"sendonly"}),a=gt.get(n);a&&(a._senders={video:e.sender,audio:t.sender}),o=r.createDataChannel("peerwatch",{ordered:!0}),gt.get(n).dc=o,Yr(n,o)}else r.ondatachannel=e=>{o=e.channel;const t=gt.get(n)||{pc:r,dc:null,name:null};t.pc=r,t.dc=o,gt.set(n,t),Yr(n,o)};return r.oniceconnectionstatechange=()=>{const e=r.iceConnectionState;"connected"!==e&&"completed"!==e||(tn(!0,"Connected"),i(`Peer ${n}: ICE ${e}`,"sys")),"failed"!==e&&"disconnected"!==e||(tn(!1,`Connection ${e}`),i(`Peer ${n}: ICE ${e}`,"err"))},r.onconnectionstatechange=()=>{const e=r.connectionState;"connected"===e&&(tn(!0,"Connected"),i(`Peer ${n}: connected`,"sys"),"host"===nt&&(Hr(o),Zr(n))),"closed"===e&&i(`Peer ${n}: closed`,"sys")},e||(r.ontrack=e=>{if(e.streams&&e.streams[0])for(const t of e.streams[0].getTracks())dt.addTrack(t);else e.track&&dt.addTrack(e.track);rn(!1),an(),S.play().catch(()=>{rn(!0)})}),vt=n,Ar(),Kr(),n}function Yr(e,t){let n=gt.get(e);n||(n={pc:null,dc:null,name:null},gt.set(e,n)),n.dc=t,t.onopen=()=>{i(`Data channel open (${e})`,"sys"),"viewer"===nt&&t.send(JSON.stringify({t:jt.ctrl,at:Date.now(),payload:{type:"where"}})),tn(!0,"Connected");const n=d(Te.value,30)||("host"===nt?"Host":"Viewer");t.send(JSON.stringify({t:jt.hello,name:n,role:nt})),Vt||function(){if(Vt)return;Vt=setInterval(()=>{const t=Date.now(),n=Number(S.currentTime||0);for(const e of gt.values())if("open"===e.dc?.readyState){e._pingSentAt=performance.now(),e.dc.send(JSON.stringify({t:jt.ping,at:t}));"host"===nt&&e.dc.send(JSON.stringify({t:jt.ctrl,at:t,payload:{type:"host-state",t:n,serverTimeMs:t,paused:S.paused,rate:Number(S.playbackRate||1),durationSec:(Number.isFinite(Number(S.duration))&&Number(S.duration)>0?Number(S.duration):(Cn?.durationSec||0)),maxAvailableSeg:(Number.isFinite(Rn)?Rn:-1),videoId:(Cn?.videoId||null),segmentDurationMs:(Cn?.segDurMs||In||2e3),mime:(Cn?.mime||"video/mp4"),codecs:(Cn?.codecs||"")}}))}},1000),Bt||(Bt=setInterval(()=>{if("viewer"!==nt)return;if(Date.now()-(y.updatedAt||0)>8e3)return;if(S.seeking)return;const e=Number(S.currentTime||0),t=Number.isFinite(Number(y.t))?Number(y.t):e,n=y.paused?0:(Date.now()-(y.serverTimeMs||Date.now()))/1e3*(Number(y.rate||1)),r=t+n,o=r-e,a=Math.abs(o);if(y.paused){try{S.pause()}catch{};try{S.playbackRate=1}catch{};return}if(S.paused)return;if(a<.08){try{S.playbackRate=1}catch{};return}if(a<.4){let t=1;t=o>.08?1+Math.min(.1,.03*o):o<-.08?1-Math.min(.1,.03*-o):1;try{S.playbackRate=t}catch{};return}try{S.playbackRate=1}catch{};if(a>2){try{if(Cn?.videoId&&Cn?.segDurMs&&"function"==typeof Cn.rebuildMSE){let rr=r,ms=Number(y.maxAvailableSeg??-1),sd=Cn.segDurMs;if(ms>=0&&sd>0){const mt=(ms+1)*sd/1e3;rr=Math.min(rr,Math.max(0,mt-.3))}const e=Math.max(0,Math.floor(1e3*rr/sd));Cn.rebuildMSE(e,"drift snap")}else S.currentTime=r}catch{}}},250))}(),"host"===nt&&(Hr(t),Zr(e))},t.onmessage=t=>{let n;try{n=JSON.parse(t.data)}catch{return}!function(e,t){const n=gt.get(e);if(t.t===jt.hello){if(n.name=t.name||"Friend",n.role="host"===t.role?"host":"viewer",i(`${n.name} joined`,"sys"),"host"===nt&&"host"===n.role){try{n.dc?.send(JSON.stringify({t:jt.hostTaken}))}catch(e){}n.role="viewer"}return"viewer"===nt&&("host"!==n.role||wt||(wt=e,i(`Host set: ${n.name}`,"sys"))),Ar(),void Kr()}if(t.t===jt.chat)return c(t.from||"Friend",t.text||"","t"),void O(t.from||"Friend",t.text||"");if(t.t===jt.hostTaken){if("host"===nt){l("Another host is already active â€” switching you to Viewer");const e=Mt(It);nn("viewer"),co(),e?(oo(e),tn(!1,"Connectingâ€¦"),Ut("viewer",e)):(oo(""),tn(!1,"Not connected"))}return}if(t.t===jt.vtt&&"viewer"===nt){if(wt&&e!==wt)return;wt||"host"!==n?.role||(wt=e);const r=t.id||(crypto?.randomUUID?crypto.randomUUID().slice(0,8):String(Date.now())),o=t.name||"Subtitles";return void(mt.some(e=>e.id===r)||(Bn({id:r,name:o,vtt:t.vtt,source:"remote",broadcast:!1}),0))}if(t.t===jt.subsStyle&&"viewer"===nt){if(wt&&e!==wt)return;return wt||"host"!==n?.role||(wt=e),void tr(t.style)}if(t.t===jt.ctrl&&"host"===nt){const e=t.payload||{};if("report"===e.type)return}if(t.t===jt.ctrl&&"viewer"===nt){if(wt&&e!==wt)return;return wt||"host"!==n?.role||(wt=e),void function(e){if(!e)return;"viewer"===nt&&("play"===e.type&&(y.paused=!1),"pause"===e.type&&(y.paused=!0),"seek"===e.type&&(Number.isFinite(Number(e.t))&&(y.t=Number(e.t)),e.paused&&(y.paused=!0)),"state"===e.type&&(y.paused=!!e.paused,y.rate=Number(e.rate??1)||1,Number.isFinite(Number(e.t))&&(y.t=Number(e.t))),y.updatedAt=Date.now());try{const d=Number(S.duration||0);(!isFinite(d)||d<=0)&&vH(y.t,Number(e.durationSec||y.durationSec||0))}catch{};if("where"===e.type&&"host"===nt){try{jr?Br(jr):(Cn&&Cn.videoId&&Br({type:"load-seg",mode:"mse",videoId:Cn.videoId,segmentDurationMs:Cn.segDurMs,startTime:Number(S.currentTime||0),durationSec:Cn.durationSec,playlistUrl:`${cn()}/seg/hls/${Cn.videoId}/out.m3u8`,mime:Cn.mime,codecs:Cn.codecs})),Vr&&Vr()}catch{}return};if("load-url"===e.type)return S.srcObject=null,S.src=e.url,rn(!1),void an();if("load-seg"===e.type){if(e.playlistUrl){try{window.__pwHls&&window.__pwHls.destroy&&window.__pwHls.destroy()}catch{};if(S.canPlayType&&S.canPlayType("application/vnd.apple.mpegurl")){S.srcObject=null,S.src=e.playlistUrl,rn(!1),an();return}if(window.Hls&&Hls.isSupported&&Hls.isSupported()){try{const h=new Hls;window.__pwHls=h,h.loadSource(e.playlistUrl),h.attachMedia(S),rn(!1),an();return}catch{}}}return void _n(e).catch(e=>{try{Cn=null}catch{};i("Segmented playback failed: "+(e?.message||e),"err")})}if("host-state"===e.type){try{Number.isFinite(Number(e.t))&&(y.t=Number(e.t));y.paused=!!e.paused;y.rate=Number(e.rate??y.rate??1)||1;y.maxAvailableSeg=Number(e.maxAvailableSeg??y.maxAvailableSeg??-1);y.serverTimeMs=Number(e.serverTimeMs??y.serverTimeMs??Date.now());y.readyHi=y.maxAvailableSeg;y.durationSec=Number(e.durationSec??y.durationSec??0);y.updatedAt=Date.now();const dur=Number(S.duration||0);if(!isFinite(dur)||dur<=0){vH(y.t,y.durationSec);}}catch{};try{if(e.videoId&&("viewer"===nt)){const vid=String(e.videoId||"");if(vid&&(!Cn||Cn.videoId!==vid)){_n({videoId:vid,segmentDurationMs:Number(e.segmentDurationMs||e.segDurMs||2e3),startTime:(()=>{let st=Number(y.t||0),sd=Number(e.segmentDurationMs||e.segDurMs||2e3),ms=Number(e.maxAvailableSeg??-1);if(ms>=0&&sd>0){const mt=(ms+1)*sd/1e3;st=Math.min(st,Math.max(0,mt-.8))}return st})(),durationSec:Number(y.durationSec||0),mime:String(e.mime||"video/mp4"),codecs:String(e.codecs||"")}).catch(async err=>{try{Cn=null}catch{};const msg=(err?.message||err);i("MSE init from host-state failed: "+msg,"err");try{const id=String(e.videoId||"");if(id){const u=new URL(Pt.replace(/^ws/i,"http"));u.pathname="/seg/meta",u.searchParams.set("videoId",id);const r=await fetch(u.toString(),{cache:"no-store"});if(r.ok){const j=await r.json(),cc=String(j.codecs||""),mm=String(j.mime||"video/mp4");if(cc){i("[MSE] retrying init with /seg/meta codecs","sys");await _n({videoId:id,segmentDurationMs:Number(j.segmentDurationMs||e.segmentDurationMs||e.segDurMs||2e3),startTime:(()=>{let st=Number(y.t||0),sd=Number(e.segmentDurationMs||e.segDurMs||2e3),ms=Number(e.maxAvailableSeg??-1);if(ms>=0&&sd>0){const mt=(ms+1)*sd/1e3;st=Math.min(st,Math.max(0,mt-.8))}return st})(),durationSec:Number(y.durationSec||0),mime:mm,codecs:cc})}}}}catch(e2){i("MSE meta-retry failed: "+(e2?.message||e2),"err")}})}}}catch{}return}"play"===e.type&&On(y.t??S.currentTime);"pause"===e.type&&S.pause();if("seek"===e.type){e.paused&&S.pause();const t=Number(e.t??S.currentTime);if(Cn&&Cn.videoId){const e=Number(S.currentTime||0);if(Math.abs(e-t)>2)return void _n({videoId:Cn.videoId,segmentDurationMs:Cn.segDurMs,startTime:t,mime:Cn.mime,codecs:Cn.codecs,durationSec:Cn.durationSec}).catch(()=>{})}S.currentTime=t,e.paused||On(t)}"rate"===e.type&&Yt(e.rate??1);"subs"===e.type&&zn(!!e.enabled);if("audioSrc"===e.type){const t="external"===e.mode?"external":"video";ct=t,he&&(he.value=t),Qr(),Xr()}if("sync"===e.type){return;const t=Number(e.t);if(Number.isFinite(t)&&!S.seeking){const n=t-Number(S.currentTime||0),r=Math.abs(n);if(e.paused?S.paused||S.pause():S.paused&&S.play().catch(()=>{}),"snap"===e.action||r>=3&&n>0){try{S.playbackRate=1}catch(e){}try{S.currentTime=t}catch(e){}}else{const t=Number(e.rate);if(Number.isFinite(t)){try{S.playbackRate=t}catch(e){}if(r<.15)try{S.playbackRate=1}catch(e){}}}}return}"room"===e.type&&(Qt=d(e.name,30)||"Room",Le&&(Le.value=Qt),en(!1),Xt(Qt));if("state"===e.type){if("viewer"===nt)try{y.t=Number(e.t??0)||0,y.rate=Number(e.rate??1)||1,y.paused=!!e.paused,y.seg=Number(e.seg),y.readyHi=Number(e.readyHi),y.segDurMs=Number(e.segDurMs),y.durationSec=Number(e.durationSec),y.receivedAt=performance.now()}catch(e){}Yt(e.rate??1),zn(!1!==e.subs);const t=e.t??0;Cn&&Cn.videoId&&Math.abs((S.currentTime||0)-t)>2?_n({videoId:Cn.videoId,segmentDurationMs:Cn.segDurMs,startTime:t,mime:Cn.mime,codecs:Cn.codecs,durationSec:Cn.durationSec}).catch(()=>{}):Math.abs(S.currentTime-t)>.15&&(S.currentTime=t),e.paused?S.pause():On(t)}}(t.payload)}if(t.t===jt.ping)return void n.dc?.send(JSON.stringify({t:jt.pong,at:t.at}));if(t.t===jt.pong){const e=performance.now(),t=n._pingSentAt||e;Jt=Math.round(e-t)}}(e,n)},t.onclose=()=>{i(`Data channel closed (${e})`,"sys")}}function Zr(e){if("host"!==nt)return;const t=gt.get(e);if("open"===t?.dc?.readyState){if(jr)try{t.dc.send(JSON.stringify({t:jt.ctrl,at:Date.now(),payload:jr}))}catch{}try{t.dc.send(JSON.stringify({t:jt.ctrl,at:Date.now(),payload:{type:"state",paused:S.paused,t:S.currentTime,seg:In?Math.max(0,Math.floor(1e3*(S.currentTime||0)/In)):void 0,readyHi:Number.isFinite(Rn)?Rn:-1,segDurMs:In||void 0,durationSec:An||void 0,rate:S.playbackRate,subs:ht}}))}catch{}try{t.dc.send(JSON.stringify({t:jt.subsStyle,style:Qn}))}catch(e){}}}function Qr(){try{S.volume=lt}catch{}try{_e.volume=lt}catch{}if("external"===ct&&_e&&_e.src){try{S.muted=!0}catch{}try{_e.muted=!!ut||0===Number(lt)}catch{}}else{try{_e.muted=!0}catch{}try{S.muted=!!ut||0===Number(lt)}catch{}}}function Xr(){if("external"===ct&&_e&&_e.src){try{S.muted=!0}catch{}try{_e.muted=!!ut||0===Number(lt)}catch{}try{S.volume=lt}catch{}try{_e.volume=lt}catch{}try{_e.playbackRate=S.playbackRate||1}catch{}try{const e=Number(S.currentTime||0);if(Number.isFinite(e)){const t=Number(_e.currentTime||0);(!Number.isFinite(t)||Math.abs(t-e)>.15)&&(_e.currentTime=e)}}catch{}if(S.paused)try{_e.pause()}catch{}else _e.play().catch(()=>{})}else{try{_e.pause()}catch{}try{_e.muted=!0}catch{}try{_e.volume=lt}catch{}try{S.volume=lt}catch{}try{S.muted=!!ut||0===Number(lt)}catch{}}}function eo(){st=function(){if(!ot)return null;const e=new MediaStream,t=ot.getVideoTracks?.()[0];t&&e.addTrack(t);let n=null;return"external"===ct&&at&&(n=at.getAudioTracks?.()[0]||null),n||(n=ot.getAudioTracks?.()[0]||null),n&&e.addTrack(n),e}(),rt=null;for(const{pc:e}of gt.values())to(e)}function to(e){if(!rt)return;let t=null;for(const n of gt.values())if(n?.pc===e){t=n;break}const n={video:rt.getVideoTracks?.()[0]||null,audio:rt.getAudioTracks?.()[0]||null},r=t?._senders||{};for(const t of["video","audio"]){const o=n[t],a=r[t]||e.getSenders().find(e=>e.track?.kind===t);a?a.replaceTrack(o):o&&e.addTrack(o,rt)}}async function no(e,t){if("host"!==nt)return;if(gt.has(e)){try{gt.get(e).pc?.close?.()}catch{}gt.delete(e)}const n=qr({asHost:!0,forcedPeerId:e}),{pc:r}=gt.get(n);if(gt.get(n).name=t||"Viewer",gt.get(n).role="viewer",rt){for(const e of rt.getTracks())r.addTrack(e,rt);try{if(audioStream)for(const e of audioStream.getTracks())r.addTrack(e,audioStream)}catch{}}const o=await r.createOffer();await r.setLocalDescription(o),await ro(r),Ot({type:"offer",v:1,roomId:It,to:e,from:kt,peerId:n,sdp:r.localDescription,meta:{name:d(Te?.value||"",30)||"Host",room:d(Le?.value||"",30)||"Room"}}),Kr(),i(`Sent offer to ${t||"Viewer"}.`,"sys")}function ro(e){return new Promise(t=>{if("complete"===e.iceGatheringState)return t();const n=()=>{"complete"===e.iceGatheringState&&(e.removeEventListener("icegatheringstatechange",n),t())};e.addEventListener("icegatheringstatechange",n),setTimeout(()=>t(),1500)})}function oo(e){It=Mt(e)||"",Rt(),function(){const e=It||"";qe&&(qe.value=e&&8===e.length?e.slice(0,4)+" "+e.slice(4):e)}()}function ao(){const e=Je.value.trim();if(!e)return;Je.value="";const t=d(Te.value,30)||("host"===nt?"Host":"Me");Lt(kt,t),c(t,e,"me",kt),O(t,e);const n={t:jt.chat,clientId:kt,from:t,text:e};let r=!1;for(const e of gt.values())if("open"===e.dc?.readyState)try{e.dc.send(JSON.stringify(n)),r=!0}catch{}!r&&Ct&&Ot({type:"chat",from:t,text:e,roomId:It,clientId:kt})}function so(){J&&(J.classList.remove("on"),J.setAttribute("aria-hidden","true"))}function io(){const e=(z?.value??"").trim();e?(Je.value=e,ao(),so()):so()}function co(){!function(){if(Vt){try{clearInterval(Vt)}catch{}Vt=null}if(Bt){try{clearInterval(Bt)}catch{}Bt=null}}();try{clearTimeout(Wr)}catch{}Wr=null,function(e=""){try{if(Nt){Dt=!0;try{Nt.close(1e3,d(e||"close",40))}catch{Nt?.close?.()}}}finally{Ct=!1,Nt=null,Dt=!1}}("disconnect");for(const[e,t]of Array.from(gt.entries())){try{t.dc?.close()}catch{}try{t.pc?.close()}catch{}gt.delete(e)}vt=null,Ar(),Kr(),tn(!1,"Not connected");try{__pwSegHost.clear();__pwSegViewer.clear();__pwRenderSeg()}catch{}}S.addEventListener("seeked",()=>{"host"===nt&&(clearTimeout(Wr),Wr=setTimeout(()=>Br({type:"seek",t:S.currentTime,paused:S.paused}),120))}),S.addEventListener("play",()=>{"host"===nt&&((window.__pwHostHold&&!(Number.isFinite(Rn)&&Rn>=Math.ceil(5e3/(In||2e3))-1))?(S.pause(),l("Waiting for initial 5s uploadâ€¦")):(window.__pwHostHold=!1,Br({type:"play"}))) }),S.addEventListener("pause",()=>{"host"===nt&&Br({type:"pause"})}),S.addEventListener("play",()=>{"external"===ct&&Xr()}),S.addEventListener("pause",()=>{if("external"===ct)try{_e.pause()}catch{}}),S.addEventListener("seeking",()=>{if("external"===ct&&_e&&_e.src)try{_e.currentTime=S.currentTime||0}catch{}}),S.addEventListener("ratechange",()=>{if("external"===ct&&_e&&_e.src)try{_e.playbackRate=S.playbackRate||1}catch{}}),S.addEventListener("volumechange",()=>{if(_e)try{_e.volume=S.volume,_e.muted=S.muted}catch{}}),ke&&ke.addEventListener("click",async()=>{const e=be||U;document.fullscreenElement?await document.exitFullscreen():await e.requestFullscreen().catch(()=>{})}),(be||U).addEventListener("mousemove",E),(be||U).addEventListener("touchstart",E,{passive:!0}),xe&&xe.addEventListener("click",async()=>{if(!document.pictureInPictureEnabled)return l("PiP not supported");try{document.pictureInPictureElement?await document.exitPictureInPicture():await S.requestPictureInPicture()}catch{l("PiP failed")}}),window.addEventListener("keydown",e=>{try{const t=e.target&&e.target.tagName?String(e.target.tagName).toLowerCase():"";if("input"===t||"textarea"===t||e.target?.isContentEditable)return;if("host"!==nt){if(e.ctrlKey||e.metaKey)return;if("F5"===e.key||"F12"===e.key)return;const t=e.key,n=e.code,r="string"==typeof t?t.toLowerCase():"";return(k.has(t)||"Space"===n||"f"===r||"m"===r||","===r||"."===r)&&(e.preventDefault(),e.stopPropagation(),w(!0)),"ArrowUp"===t&&(e.preventDefault(),qt(e.shiftKey?.1:.05)),void("ArrowDown"===t&&(e.preventDefault(),qt(e.shiftKey?-.1:-.05)))}if("Space"===e.code)return e.preventDefault(),void ee?.click?.();e.key&&"f"===e.key.toLowerCase()&&ke?.click?.(),e.key&&"m"===e.key.toLowerCase()&&(S.muted=!S.muted,Zt());const n=e.shiftKey?15:5;"ArrowLeft"===e.key&&(e.preventDefault(),Jr(-n)),"ArrowRight"===e.key&&(e.preventDefault(),Jr(n)),"ArrowUp"===e.key&&(e.preventDefault(),qt(e.shiftKey?.1:.05)),"ArrowDown"===e.key&&(e.preventDefault(),qt(e.shiftKey?-.1:-.05)),","===e.key&&(e.preventDefault(),zr(-1)),"."===e.key&&(e.preventDefault(),zr(1))}catch(e){try{i(`Key handler error: ${e?.message||e}`,"err")}catch{}}},!0),a(Ke,"click",async()=>{const e=Mt(It)||"";if(!e)return l("No active room. Start a new room or join one.");It=e;const t=function(){const e=new URL(location.href);e.searchParams.set("room",It);const t=Ft()||"";return t?e.searchParams.set("ws",t):e.searchParams.delete("ws"),e.hash="",e.toString()}();await f(t)}),a(qe,"click",async()=>{const e=Mt(It)||"";e&&(await f(e),l("Room number copied."))}),a(Ye,"click",async()=>{const e=function(){try{const e=new Uint32Array(1);return crypto.getRandomValues(e),String(e[0]%1e8).padStart(8,"0")}catch(e){return String(Math.floor(1e8*Math.random())).padStart(8,"0")}}();Ze&&(Ze.value=e.slice(0,4)+" "+e.slice(4));l(!(!Nt||1!==Nt.readyState||!It)?"New room number generated. Current room unchanged.":"New room number generated. Click Join to enter it.")}),a(Qe,"click",()=>{const e=Mt(Ze?.value||"");if(!e)return l("Enter an 8-digit room number");nn("viewer"),co();try{Nt?.close?.()}catch(e){}Nt=null,Ct=!1,At=null,oo(e),function(e){try{const t=new URL(location.href),n=Mt(e);n?t.searchParams.set("room",n):t.searchParams.delete("room"),t.hash="",history.replaceState(null,"",t.toString())}catch(e){}}(e),Ut("viewer",e),l("Joining room "+e)}),a(Ve,"click",ao),a(Je,"keydown",e=>{"Enter"===e.key&&ao()}),a(W,"click",io),a(G,"click",so),a(z,"keydown",e=>{"Enter"===e.key&&(e.preventDefault(),io()),"Escape"===e.key&&(e.preventDefault(),so())}),document.addEventListener("keydown",e=>{if(("c"===e.key||"C"===e.key)&&(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement)){if(function(e){if(!e)return!1;const t=(e.tagName||"").toLowerCase();return"input"===t||"textarea"===t||"select"===t||e.isContentEditable}(e.target))return;return e.preventDefault(),void(J&&z&&(R(),j&&j.classList.add("on"),J.classList.add("on"),J.setAttribute("aria-hidden","false"),z.value="",setTimeout(()=>z.focus(),0)))}"Escape"===e.key&&J?.classList.contains("on")&&(e.preventDefault(),so())}),a(ze,"click",()=>{try{const e=document.createElement("canvas");e.width=S.videoWidth||1280,e.height=S.videoHeight||720;e.getContext("2d").drawImage(S,0,0,e.width,e.height);const t=e.toDataURL("image/png"),n=document.createElement("a");n.href=t,n.download="snapshot.png",n.click(),l("Snapshot saved")}catch{l("Snapshot failed")}}),a(We,"click",async()=>{const e=gt.values().next().value;if(!e)return l("No peer");try{const t=await e.pc.getStats();let n=[];t.forEach(e=>{"outbound-rtp"===e.type&&"video"===e.kind&&n.push(`Outbound video: ${Math.round(e.bitrateMean||0)} bps, framesEncoded=${e.framesEncoded}`),"inbound-rtp"===e.type&&"video"===e.kind&&n.push(`Inbound video: framesDecoded=${e.framesDecoded}, packetsLost=${e.packetsLost}`),"candidate-pair"===e.type&&"succeeded"===e.state&&e.nominated&&n.push(`RTT: ${Math.round(1e3*(e.currentRoundTripTime||0))} ms`)}),null!=Jt&&n.push(`App ping RTT: ${Jt} ms`),i("<b>Stats</b><br>"+n.map(u).join("<br>"),"sys"),l("Stats logged")}catch{l("Stats failed")}}),a(Ge,"click",()=>{co(),"viewer"===nt&&(dt=new MediaStream,S.srcObject=dt),oo(""),l("Disconnected")}),a(S,"timeupdate",v),a(S,"play",T),a(S,"pause",T),S.addEventListener("loadedmetadata",()=>{S.volume=Number(ie.value),Yt(S.playbackRate||1),ve&&(ve.textContent=p(S.duration||0)),v(),T();try{if(S.textTracks&&S.textTracks.length){ht=!0;for(const e of S.textTracks)e.mode="showing";l("Embedded subtitles detected"),0}}catch{}});try{!function(){const e=t(localStorage.getItem("peerwatch_prefs")||"{}",{});Te.value=e.displayName||localStorage.getItem(xt)||"",Le&&(Le.value=e.roomName||"");const n=e.theme||"mono";Fe.value=n,zt(n),Ce(),ie.value=e.vol??1,lt=Number(ie.value),S.volume=lt,ut=!!e.muted,S.muted=ut,Qr();const r=e.rate??1;S.playbackRate=Number(r),M(),yt=!1!==e.videoMessagesEnabled,A(yt,!1),Gt()}(),function(){if(Ne&&Fe){Ne.innerHTML="";for(const e of Array.from(Fe.options)){const t=document.createElement("button");t.type="button",t.className="pwSelectOpt",t.role="option",t.dataset.value=e.value,t.textContent=e.textContent,t.addEventListener("click",()=>{Fe.value=e.value,Fe.dispatchEvent(new Event("change",{bubbles:!0})),De()}),Ne.appendChild(t)}Ee?.addEventListener("click",e=>{e.preventDefault(),$e&&Ee&&($e.classList.contains("open")?De():($e.classList.add("open"),Ee.setAttribute("aria-expanded","true")))}),document.addEventListener("pointerdown",e=>{$e&&($e.contains(e.target)||De())}),document.addEventListener("keydown",e=>{"Escape"===e.key&&De()}),Ce()}}(),function(){if(ir&&rr){ir.innerHTML="";for(const e of Array.from(rr.options)){const t=document.createElement("button");t.type="button",t.className="pwSelectOpt",t.role="option",t.dataset.value=e.value,t.textContent=e.textContent,t.addEventListener("click",()=>{rr.value=e.value,rr.dispatchEvent(new Event("change",{bubbles:!0})),Ie(),Ae()}),ir.appendChild(t)}ar?.addEventListener("click",e=>{e.preventDefault(),or&&ar&&(or.classList.contains("open")?Ae():(or.classList.add("open"),ar.setAttribute("aria-expanded","true")))}),document.addEventListener("pointerdown",e=>{or&&(or.contains(e.target)||Ae())}),document.addEventListener("keydown",e=>{"Escape"===e.key&&Ae()}),Ie()}}(),nn("viewer"),zt(Fe?.value||document.documentElement.dataset.theme||"mono"),T(),Wt();Gh();window.addEventListener("resize",Gh),window.addEventListener("orientationchange",Gh),btnCL&&btnCL.addEventListener("click",()=>{const e=Dh(dbgL),t=`logs-${(new Date).toISOString().replace(/[:.]/g,"-")}.txt`,pf=`[${String(nt||"viewer").toUpperCase()}][${kt||"UserID"}]`,fn=pf+t;dbgSave?.checked?Hh(e,fn):f(e)}),btnCE&&btnCE.addEventListener("click",()=>{const e=Dh(dbgE),t=`errors-${(new Date).toISOString().replace(/[:.]/g,"-")}.txt`,pf=`[${String(nt||"viewer").toUpperCase()}][${kt||"UserID"}]`,fn=pf+t;dbgSave?.checked?Hh(e,fn):f(e)}),btnCA&&btnCA.addEventListener("click",()=>{const e=Dh(dbgE),t=Dh(dbgL),n=(e?e+"\n\n":"")+t,r=`debug-${(new Date).toISOString().replace(/[:.]/g,"-")}.txt`,pf=`[${String(nt||"viewer").toUpperCase()}][${kt||"UserID"}]`,fn=pf+r;dbgSave?.checked?Hh(n,fn):f(n)});const e=Mt(function(){const e=new URL(location.href);let t="";if(e.hash&&e.hash.includes("room=")){const n=e.hash.match(/room=([^&]+)/);t=n?decodeURIComponent(n[1]):""}return t||(t=e.searchParams.get("room")||""),t=d(t,64).replace(/[^a-zA-Z0-9_-]/g,""),t}());e?(oo(e),tn(!1,"Connectingâ€¦"),Ut("viewer",e)):(oo(""),tn(!1,"Not connected"),nn("viewer")),Xt(""),i("Ready. Drop a video to start hosting, or open a share link to join instantly.","sys")}catch(e){console.error(e);try{i("Init failed: "+(e?.message||e),"err")}catch{}l("Init failed (see console/log)")}});


