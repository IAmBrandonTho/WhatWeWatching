<!DOCTYPE html>

<html data-theme="mono" lang="en">
<head>
<meta charset="utf-8"/>
<script>
(()=>{
  try{
    const p = JSON.parse(localStorage.getItem('peerwatch_prefs')||'{}');
    const t = (p && p.theme) ? String(p.theme) : 'mono';
    document.documentElement.dataset.theme = t || 'mono';
  }catch(e){
    document.documentElement.dataset.theme = 'mono';
  }
})();
</script>

<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="wss://whatwewatching-signal.lilbrandon2008.workers.dev" name="signal-url"/>
<title>What We Watching — self-contained WebRTC watch room</title>
<link href="./styles.css" rel="stylesheet"/>

<script>
(function(){
  try{
    var p=new URLSearchParams(location.search);
    var on=(p.get("debug")==="1");
    window.__WW_DEBUG_ON=on;
    if(on){
      document.documentElement.classList.add("debug-on");
    }else{
      // Prevent any external/inline debug overlay from booting
      try{ window.WWDBG = null; }catch(e){}
      try{ window.__WWDBG_UI = null; }catch(e){}
    }
  }catch(e){
    window.__WW_DEBUG_ON=false;
    try{ window.WWDBG = null; }catch(e2){}
    try{ window.__WWDBG_UI = null; }catch(e2){}
  }
})();
</script>
<style>
  /* Debug UI is opt-in only */
  .debugCard{display:none!important;}
  html.debug-on .debugCard{display:block!important;}
  /* Stream Quality alignment */
  .streamQuality .sqRows{display:grid;grid-template-columns: 1fr 220px;gap:12px;align-items:center;}
  .streamQuality .sqRow{display:contents;}
  .streamQuality .sqRows > label{align-self:center;}
  .streamQuality .sqRows > div{justify-self:stretch;}
  .streamQuality .sqRows{row-gap:10px;margin-top:10px;}
</style>

</head>
<body>
<header>
<div class="wrap">
<div class="topbar">
<div class="brand">
<div aria-hidden="true" class="logo"></div>
<div>
<h1>What We Watching</h1>
<div class="mini">Self-contained Peer-To-Peer WebRTC Watch Room.</div>
</div>
</div>
<div class="row" style="gap:10px">
<button class="small inline hostOnly" id="btnStartStream" title="Start/Stop sending canvas stream to viewers" disabled>Start</button>
<button class="small" id="btnRole" title="Toggle Host/Viewer role">Viewer</button>
<button class="small inline" id="btnShare">Share</button>
<div class="pill" id="statusPill">
<span class="badge">
<span class="dot" id="netDot"></span>
<span id="netText">Not connected</span>
</span>
</div>
</div>
</div>
</div>
</header>
<main><div class="leftCol"><section class="card videoStage">
<div class="hd">
<div class="title">
<b id="playerTitle">Player</b>
<small id="roleLabel"></small>
</div>
</div>
<div class="bd">
<div class="playerShell" id="playerShell">
<div class="stage" id="stage">
<video id="video" playsinline="" crossorigin="anonymous"></video>
<audio id="audioEl" preload="auto" style="display:none"></audio>
<div aria-hidden="true" class="subsOverlay" id="subsOverlay"></div>
<div aria-hidden="true" class="videoMsgOverlay on" id="videoMsgOverlay">
<div class="videoMsgBubble" id="videoMsgA"></div>
<div class="videoMsgBubble" id="videoMsgB"></div>
<div aria-hidden="true" class="videoMsgComposer" id="videoMsgComposer">
<input autocomplete="off" id="videoMsgComposeInput" placeholder="Type a chat message…" type="text"/>
<div class="videoMsgComposeActions">
<button class="primary" id="videoMsgComposeSend" type="button">Send</button>
<button id="videoMsgComposeCancel" type="button">Cancel</button>
</div>
</div>
</div>
<div class="overlay" id="overlay">
<div class="dropHint" id="dropHint">
            Drop a video file here (Host) • or connect as Viewer
            <div class="mini" style="margin-top:6px">Supported by your browser (MP4/H.264 is safest)</div>
</div>
</div>
</div>
<div aria-label="Player controls" class="pwControls" id="pwControls">
<div class="pwSeekTop">
<div class="pwSeekLine">
<input aria-label="Seek" class="seekTop" id="seek" max="1000" min="0" step="1" type="range" value="0"/>
<span class="timeInline"><span id="timeCur">--:--</span> / <span id="timeDur">--:--</span></span>
</div>
</div>
<div class="pwRow space">
<div class="pwLeft">
<button aria-label="Play/Pause" class="iconBtn primary" id="btnPlayPause" title="Play/Pause (Space)">
<span aria-hidden="true" class="iconSwap">
<span class="off"><svg aria-hidden="true" class="ico fill" viewbox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg></span>
<span class="on"><svg aria-hidden="true" class="ico fill" viewbox="0 0 24 24"><path d="M7 5h4v14H7zM13 5h4v14h-4z"></path></svg></span>
</span>
</button>
<button aria-label="Back 10 seconds" class="iconBtn small ctl-skip10" id="btnRewind" title="Back 10s"><span aria-hidden="true"><svg aria-hidden="true" class="ico stroke" viewbox="0 0 24 24"><path d="M12 5v6l-4-3 4-3z"></path><path d="M12 11v6l-4-3 4-3z"></path><path d="M20 18a8 8 0 1 1-1.8-5.1"></path></svg></span></button>
<button aria-label="Forward 10 seconds" class="iconBtn small ctl-skip10" id="btnFwd" title="Forward 10s"><span aria-hidden="true"><svg aria-hidden="true" class="ico stroke" viewbox="0 0 24 24"><path d="M12 5v6l4-3-4-3z"></path><path d="M12 11v6l4-3-4-3z"></path><path d="M4 18a8 8 0 1 0 1.8-5.1"></path></svg></span></button>
<button aria-label="Previous frame" class="iconBtn small ctl-step" id="btnStepBack" title="Step back 1 frame"><span aria-hidden="true"><svg aria-hidden="true" class="ico stroke" viewbox="0 0 24 24"><path d="M11 7l-6 5 6 5V7z"></path><path d="M19 7l-6 5 6 5V7z"></path></svg></span></button>
<button aria-label="Next frame" class="iconBtn small ctl-step" id="btnStepFwd" title="Step forward 1 frame"><span aria-hidden="true"><svg aria-hidden="true" class="ico stroke" viewbox="0 0 24 24"><path d="M13 7l6 5-6 5V7z"></path><path d="M5 7l6 5-6 5V7z"></path></svg></span></button>
</div>
<div class="pwRight sliders">
<button aria-label="Mute" class="iconBtn small" id="btnMute" title="Mute/Unmute (M)"><span aria-hidden="true" class="iconSwap">
<span class="off"><svg aria-hidden="true" class="ico stroke" viewbox="0 0 24 24"><path d="M11 5 6 9H3v6h3l5 4z"></path><path d="M15.5 8.5a4.5 4.5 0 0 1 0 7"></path><path d="M17.5 6a7.5 7.5 0 0 1 0 12"></path></svg></span>
<span class="on"><svg aria-hidden="true" class="ico stroke" viewbox="0 0 24 24"><path d="M11 5 6 9H3v6h3l5 4z"></path><path d="M16 9l5 6"></path><path d="M21 9l-5 6"></path></svg></span>
</span></button>
<span class="volWrap" title="Volume">
<span class="sliderLabel ctl-volbar" title="Volume">
<input id="vol" max="1" min="0" step="0.01" type="range" value="1"/>
</span>
</span>
<button aria-label="Picture-in-Picture" class="iconBtn small ctl-pip" id="btnPiP" title="Picture-in-Picture"><span aria-hidden="true"><svg aria-hidden="true" class="ico stroke" viewbox="0 0 24 24"><rect height="14" rx="2" width="18" x="3" y="5"></rect><rect height="6" rx="1" width="7" x="13" y="11"></rect></svg></span></button>
<button aria-label="Fullscreen" class="iconBtn small" id="btnFullscreen" title="Fullscreen (F)"><span aria-hidden="true"><svg aria-hidden="true" class="ico stroke" viewbox="0 0 24 24"><path d="M9 3H3v6"></path><path d="M15 3h6v6"></path><path d="M9 21H3v-6"></path><path d="M15 21h6v-6"></path></svg></span></button>
</div>
</div>
</div>
</div>
</div>
</section><section class="card debugCard" id="debugCard">
  <div class="hd">
    <div class="title"><b>Debugging</b></div>
  </div>
  <div class="bd">
    <div class="debugGrid">
      <div class="debugPane">
        <div class="debugHdr"><b>Errors</b></div>
        <div aria-live="polite" class="log debugLog" id="dbgErrors"></div>
      </div>
      <div class="debugPane">
        <div class="debugHdr"><b>Logs</b></div>
        <div aria-live="polite" class="log debugLog" id="dbgLog"></div>
      </div>
    </div>

    <div class="debugFooter">
      <label class="chk" title="When checked, clicking copy will download a .txt file instead of copying to clipboard.">
        <input id="dbgSaveTxt" type="checkbox"/>
        <span>.TXT</span>
      </label>

      <div class="debugBtns">
        <button class="small" id="btnCopyLogs" type="button">Copy Logs</button>
        <button class="small" id="btnCopyErrors" type="button">Copy Errors</button>
        <button class="small primary" id="btnCopyAll" type="button">Copy All</button>
      </div>
    </div>
  </div>
  <!-- RIGHT: Room + settings -->
</section></div><div class="rightCol">
<aside class="card">
<div class="bd">
<!-- Chat (top) -->
<b id="chatTitle" style="font-size:13px">Chat</b>
<div aria-live="polite" class="log" id="chatLog"></div>
<div class="chat">
<input id="chatMsg" placeholder="Say something…" type="text"/>
<button class="primary" id="btnSend">Send</button>
</div>
<div class="hr"></div>
<!-- Identity + theme (below chat) -->
<div class="kv compact">
<label for="displayName">Display Name</label>
<input id="displayName" maxlength="30" placeholder="e.g., Alex" type="text"/>
</div>
<div class="kv compact hostOnly" id="roomNameRow">
<label for="roomName">Room Name</label>
<input id="roomName" maxlength="30" placeholder="e.g., Movie Night" type="text">
</input></div>
<div class="grid2">
<div style="grid-column:1/-1;">
<div class="kv compact" style="grid-template-columns: 130px 1fr">
<label for="themeSel">Theme</label>
<select aria-hidden="true" class="nativeSelect" id="themeSel" tabindex="-1">
<option value="mono" selected>Mono</option>
<option value="midnight">Midnight</option>
<option value="solar">Forest</option>
<option value="candy">Candy</option>
<option value="ember">Ember</option>
<option value="crimson">Crimson</option>
</select>
<div class="pwSelect" id="themePicker">
<button aria-expanded="false" aria-haspopup="listbox" class="pwSelectBtn" id="themeBtn" type="button">
<span id="themeBtnLabel">Theme</span>
<span aria-hidden="true" class="pwCaret">▾</span>
</button>
<div aria-label="Theme options" class="pwSelectMenu" id="themeMenu" role="listbox"></div>
</div>
</div>
</div>
</div>
<div class="hr"></div>
<div class="peopleRow">
<b style="font-size:13px">People:</b>
<div class="members" id="members"></div>
</div>
<div class="hr"></div>
<details>
<summary style="cursor:pointer; color: var(--muted);">Room</summary>
<div class="kv compact" style="margin-top:12px">
<label>Current Room</label>
<div class="row connRow">
<input id="roomCode" inputmode="numeric" maxlength="8" pattern="[0-9 ]*" placeholder="--------" readonly="" type="text"/>
<button class="small" id="btnNewRoom" title="Generate a new room number">New Room</button>
</div>
</div>
<div class="kv compact" style="margin-top:10px">
<label for="joinRoomInput"></label>
<div class="row connRow">
<input id="joinRoomInput" inputmode="numeric" maxlength="9" pattern="[0-9 ]*" placeholder="1234 5678" type="text"/>
<button class="small" id="btnJoinRoom" title="Join as Viewer">Join Room</button>
</div>
</div>


</details>
<div class="hr"></div>
<!-- Player -->
<details id="playerDetails">
<summary style="cursor:pointer; color: var(--muted);">Player</summary>
<div style="margin-top:12px; display:flex; flex-direction:column; gap:12px">
<div class="row" style="gap:10px; flex-wrap:wrap">
<button class="hostOnly" id="btnLoad">Load video</button>
<button class="hostOnly" id="btnLoadAudio">Load audio</button>
<button id="btnSnapshot">Snapshot</button>
<button id="btnStats">Stats</button>
<button class="hostOnly" id="btnSync">Sync</button>
</div>
<div class="hr" style="margin:2px 0"></div>
<div class="kv" style="grid-template-columns: 130px 1fr; margin:6px 0 0">
<label>Playback rate</label>
<div class="row" style="gap:10px; align-items:center; flex-wrap:nowrap">
<button class="small" id="btnRateDown2" title="Slow down">−</button>
<span class="ratePill" id="rateLabel2">1.00×</span>
<button class="small" id="btnRateUp2" title="Speed up">+</button>
</div>
</div>
<div class="kv" style="grid-template-columns: 130px 1fr; margin:6px 0 0">
<label>UI scale</label>
<div class="row" style="gap:10px; align-items:center; flex-wrap:nowrap">
<input id="uiScale" max="160" min="70" step="1" style="flex:1; min-width:160px" type="range" value="100"/>
<span class="ratePill" id="uiScaleLabel">100%</span>
</div>
</div>
<div class="kv" style="grid-template-columns: 130px 1fr; margin:6px 0 0">
<label>Video Messages</label>
<label class="chk"><input checked="" id="videoMsgsToggle" type="checkbox"> <span>Show chat messages on video</span></input></label>
</div>
<div class="kv" style="grid-template-columns: 130px 1fr; margin:6px 0 0">
<label>Audio Source</label>
<div class="row" style="gap:10px; flex-wrap:wrap; align-items:center">
<select id="audioSourceSelect" style="min-width:240px; flex:1 1 240px;">
<option value="video">Video</option>
<option value="external">Loaded audio</option>
</select>
</div>
</div>
<div class="mini" style="margin-top:2px; color: var(--muted); line-height:1.35">
            Host controls sync playback; viewers can adjust UI scale locally.
            Scales the on-video controls (windowed + fullscreen).
          </div>
</div>
</details>
<div class="hr"></div>
<details id="subsDetails">
<summary style="cursor:pointer; color: var(--muted);">Subtitles</summary>
<div class="subsSection" style="margin-top:12px; display:flex; flex-direction:column; gap:12px">
<!-- Style (2-column when roomy, stacked on small) -->
<div class="grid2 subsGrid" style="gap:12px">
<div class="kv" style="grid-column:1/-1;">
<label>Font</label>
<div>
<select aria-hidden="true" class="nativeSelect" id="subsFontSelect" tabindex="-1">
<option value="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial">System</option>
<option value="Arial, Helvetica, sans-serif">Arial</option>
<option value="Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial">Inter</option>
<option value="Verdana, Geneva, sans-serif">Verdana</option>
<option value="Tahoma, Geneva, sans-serif">Tahoma</option>
<option value="Georgia, serif">Georgia</option>
<option value="Times New Roman, Times, serif">Times</option>
<option value="Trebuchet MS, sans-serif">Trebuchet</option>
<option value="Courier New, Courier, monospace">Courier</option>
<option value="custom">Custom…</option>
</select>
<div class="pwSelect" id="subsFontPicker">
<button aria-expanded="false" aria-haspopup="listbox" class="pwSelectBtn" id="subsFontBtn" type="button">
<span id="subsFontBtnLabel">Font</span>
<span aria-hidden="true" class="pwCaret">▾</span>
</button>
<div aria-label="Font options" class="pwSelectMenu" id="subsFontMenu" role="listbox"></div>
</div>
<input id="subsFontCustom" placeholder="Custom font-family (e.g. 'Bebas Neue', Arial)" style="margin-top:8px; display:none" type="text"/>
</div>
</div>
<div class="kv" style="grid-column:1/-1;">
<label>Font Size/Color</label>
<div class="row" style="gap:10px; flex-wrap:nowrap; align-items:center">
<input id="subsFontSize" max="15" min="0.5" step="0.1" type="number"/>
<input id="subsColor" type="color"/>
<input id="subsColorText" placeholder="#ffffff" style="max-width:140px" type="text"/>
</div>
</div>
<div class="kv" style="grid-column:1/-1;">
<label>Style</label>
<div class="row" style="gap:16px; flex-wrap:nowrap; justify-content:flex-start; overflow-x:auto; padding-bottom:2px">
<label class="chk"><input id="subsBold" type="checkbox"/> <span>Bold</span></label>
<label class="chk"><input id="subsItalic" type="checkbox"/> <span>Italic</span></label>
<label class="chk"><input id="subsUnderline" type="checkbox"/> <span>Underline</span></label>
</div>
</div>
<div class="kv" style="grid-column:1/-1;">
<label>Outline</label>
<div class="row" style="gap:10px; flex-wrap:nowrap; align-items:center">
<input id="subsOutlineColor" type="color"/>
<input id="subsOutlineThick" max="20" min="0" step="0.5" style="max-width:110px" type="number"/>
</div>
</div>
<div class="kv" style="grid-column:1/-1;">
<label>Drop Shadow</label>
<div class="row" style="gap:10px; flex-wrap:nowrap; align-items:center">
<input id="subsShadowColor" type="color"/>
<input id="subsShadowThick" max="30" min="0" step="0.5" style="max-width:110px" type="number"/>
</div>
</div>
<div class="kv">
<label>Subtitle opacity (%)</label>
<input id="subsOpacity" max="100" min="0" step="1" style="max-width:110px; justify-self:start;" type="number"/>
</div>
<div class="kv">
<label>BG Opacity (%)</label>
<input id="subsBgOpacity" max="100" min="0" step="1" style="max-width:110px; justify-self:start;" type="number"/>
</div>
<div class="kv" style="grid-column:1/-1;">
<label>Bottom Position</label>
<input id="subsBottom" max="45" min="0" step="0.5" style="max-width:110px; justify-self:start;" type="number"/>
</div>
<div class="kv" style="grid-column:1/-1;">
<label>Left Position</label>
<input id="subsLeft" max="45" min="0" step="0.5" style="max-width:110px; justify-self:start;" type="number"/>
</div>
</div>
<!-- Track selection + timing (moved to bottom) -->
<div class="kv" style="grid-template-columns: 130px 1fr;">
<label>Active Sub</label>
<div>
<select aria-hidden="true" class="nativeSelect" id="subsTrackSel" tabindex="-1"></select>
<div class="pwSelect" id="subsTrackPicker">
<button aria-expanded="false" aria-haspopup="listbox" class="pwSelectBtn" id="subsTrackBtn" type="button">
<span id="subsTrackBtnLabel">No subtitles</span>
<span aria-hidden="true" class="pwCaret">▾</span>
</button>
<div aria-label="Subtitle track options" class="pwSelectMenu" id="subsTrackMenu" role="listbox"></div>
</div>
</div>
</div>
<div class="kv" style="grid-template-columns: 130px 1fr;">
<label>
              Offset 
              <span id="subsOffsetLabel" style="font-family:var(--mono)">0ms</span>
</label>
<div class="row" style="gap:8px; flex-wrap:wrap; align-items:center">
<button class="small" id="btnSubsAdvance1000" title="Show subtitles 1000ms earlier">-1000</button>
<button class="small" id="btnSubsAdvance100" title="Show subtitles 100ms earlier">-100</button>
<button class="small" id="btnSubsOffsetReset" title="Reset timing offset">Reset</button>
<button class="small" id="btnSubsDelay100" title="Delay subtitles by 100ms">+100</button>
<button class="small" id="btnSubsDelay1000" title="Delay subtitles by 1000ms">+1000</button>
</div>
</div>
<div class="row" style="gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between">
<div class="row" style="gap:10px; flex-wrap:wrap; align-items:center">
<button id="btnLoadVtt">Load subs</button>
<button id="btnToggleSubs">Off</button>
</div>
<div class="row" style="gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end">
<button id="btnSubsReset">Reset all</button>
<button class="primary" id="btnSubsApply">Apply</button>
</div>
</div>
<div class="mini" style="color:var(--muted); margin-top:6px">
            Host-loaded tracks are shared to connected viewers. Add multiple tracks; each viewer chooses what to display from the dropdown.
          </div>
</div>
</details>
<div class="hr"></div>
<details open>
<summary style="cursor:pointer; color: var(--muted);">Stream Quality</summary>

<div class="streamQuality">

  <div class="sqRows">
    <label>Type</label>
    <div>
      <select aria-hidden="true" class="nativeSelect" id="streamTypeSel" tabindex="-1">
        <option value="p2p" selected>P2P</option>
        <option value="relay" disabled>Relay (future)</option>
      </select>
      <div class="pwSelect" id="streamTypePicker">
        <button aria-expanded="false" aria-haspopup="listbox" class="pwSelectBtn" id="streamTypeBtn" type="button">
          <span id="streamTypeBtnLabel">P2P</span>
          <span aria-hidden="true" class="pwCaret">▾</span>
        </button>
        <div aria-label="Stream type options" class="pwSelectMenu" id="streamTypeMenu" role="listbox"></div>
      </div>
    </div>

    <label>Resolution</label>
    <div>
      <select aria-hidden="true" class="nativeSelect" id="streamResSel" tabindex="-1">
        <option value="auto" selected>Auto</option>
        <option value="25">25p</option>
        <option value="50">50p</option>
        <option value="140">140p</option>
        <option value="240">240p</option>
        <option value="480">480p</option>
        <option value="720">720p</option>
        <option value="1080">1080p</option>
      </select>
      <div class="pwSelect" id="streamResPicker">
        <button aria-expanded="false" aria-haspopup="listbox" class="pwSelectBtn" id="streamResBtn" type="button">
          <span id="streamResBtnLabel">Auto</span>
          <span aria-hidden="true" class="pwCaret">▾</span>
        </button>
        <div aria-label="Resolution options" class="pwSelectMenu" id="streamResMenu" role="listbox"></div>
      </div>
    </div>

    <label>FPS</label>
    <div>
      <select aria-hidden="true" class="nativeSelect" id="streamFpsSel" tabindex="-1">
        <option value="auto" selected>Auto</option>
        <option value="1">1</option>
        <option value="10">10</option>
        <option value="15">15</option>
        <option value="24">24</option>
        <option value="30">30</option>
      </select>
      <div class="pwSelect" id="streamFpsPicker">
        <button aria-expanded="false" aria-haspopup="listbox" class="pwSelectBtn" id="streamFpsBtn" type="button">
          <span id="streamFpsBtnLabel">Auto</span>
          <span aria-hidden="true" class="pwCaret">▾</span>
        </button>
        <div aria-label="FPS options" class="pwSelectMenu" id="streamFpsMenu" role="listbox"></div>
      </div>
    </div>

    <label>Quality</label>
    <div>
      <select aria-hidden="true" class="nativeSelect" id="streamBitrateSel" tabindex="-1">
        <option value="auto" selected>Auto</option>
        <option value="250000">Ultra Low (0.25 Mbps)</option>
        <option value="500000">Low (0.5 Mbps)</option>
        <option value="1500000">Balanced (1.5 Mbps)</option>
        <option value="3000000">High (3 Mbps)</option>
        <option value="6000000">Ultra (6 Mbps)</option>
      </select>
      <div class="pwSelect" id="streamBitratePicker">
        <button aria-expanded="false" aria-haspopup="listbox" class="pwSelectBtn" id="streamBitrateBtn" type="button">
          <span id="streamBitrateBtnLabel">Auto</span>
          <span aria-hidden="true" class="pwCaret">▾</span>
        </button>
        <div aria-label="Bitrate options" class="pwSelectMenu" id="streamBitrateMenu" role="listbox"></div>
      </div>
    </div>
  </div>

  <!-- Host-only actions (Viewer disabled on purpose) -->
  <div class="row sqActions" style="gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; margin-top:10px">
    <button id="btnStreamReset">Reset</button>
    <button class="primary" id="btnStreamApply">Apply</button>
  </div>

  <!-- Legacy hint controls kept hidden for backward compatibility with minified JS; safe to remove in a future de-minified refactor. -->
  <div style="display:none">
    <select aria-hidden="true" class="nativeSelect" id="streamHintSel" tabindex="-1">
      <option value="auto" selected>Auto</option>
    </select>
    <div class="pwSelect" id="streamHintPicker">
      <button class="pwSelectBtn" id="streamHintBtn" type="button"><span id="streamHintBtnLabel">Auto</span></button>
      <div class="pwSelectMenu" id="streamHintMenu" role="listbox"></div>
    </div>
  </div>
</div>

</details>

</div>
</aside>
</div></main>
<div class="toast" id="toast"></div>
<input accept="video/*" hidden="" id="filePick" type="file"/>
<canvas id="outCanvas" hidden></canvas>
<input accept="audio/*" hidden="" id="audioPick" type="file"/>
<input accept="text/vtt,.vtt,.srt,text/srt,application/x-subrip" hidden="" id="vttPick" type="file"/>
<script crossorigin="anonymous" defer="" src="./polyfills.js" onerror="window.__pushJsErr && window.__pushJsErr('Failed to load script: '+(this.src||''))"></script>
<script defer src="./header-guard.js"></script>


<script>
(function(){

function qs(sel, root){ return (root||document).querySelector(sel); }
function qsa(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }
function onReady(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded',fn); }

/* ---------- Role toggle (Host/Viewer) ---------- */
function applyRoleToggle(){
  // Case A: app has separate Host and Viewer buttons
  const hostBtn = qsa('button').find(b => (b.textContent||'').trim().toLowerCase()==='host');
  const viewerBtn = qsa('button').find(b => (b.textContent||'').trim().toLowerCase()==='viewer');

  // If both exist, keep BOTH buttons visible (no proxy/hide)
  if(hostBtn && viewerBtn){
    // remove any old proxy from previous builds
    const oldProxy = qs('#roleToggleProxy');
    if(oldProxy) try{ oldProxy.remove(); }catch(e){}

    [hostBtn, viewerBtn].forEach(btn=>{
      if(!btn) return;
      btn.style.display = '';
      btn.hidden = false;
      btn.removeAttribute('aria-hidden');
      btn.classList.add('role-toggle-fixed');
    });

    // lock width to max of Host/Viewer so the row doesn't jump
    try{
      const tmp = hostBtn.cloneNode(true);
      tmp.style.position='absolute'; tmp.style.visibility='hidden'; tmp.style.pointerEvents='none';
      tmp.textContent='Viewer';
      document.body.appendChild(tmp);
      const w1 = tmp.getBoundingClientRect().width;
      tmp.textContent='Host';
      const w2 = tmp.getBoundingClientRect().width;
      document.body.removeChild(tmp);
      const w = Math.ceil(Math.max(w1,w2)) + "px";
      hostBtn.style.minWidth = w;
      viewerBtn.style.minWidth = w;
      hostBtn.style.textAlign = 'center';
      viewerBtn.style.textAlign = 'center';
    }catch(e){}

    return;
  }

  // Case B: app already uses a single button whose text toggles Host/Viewer
  const btn = qsa('button').find(b => /^(Host|Viewer)$/i.test((b.textContent||'').trim()));
  if(!btn || btn.dataset.patchedRole) return;
  btn.dataset.patchedRole="1";
  btn.classList.add('role-toggle-fixed');

  // lock width to max of Host/Viewer
  const tmp = btn.cloneNode(true);
  tmp.style.position='absolute'; tmp.style.visibility='hidden'; tmp.style.pointerEvents='none';
  tmp.textContent='Viewer';
  document.body.appendChild(tmp);
  const w1 = tmp.getBoundingClientRect().width;
  tmp.textContent='Host';
  const w2 = tmp.getBoundingClientRect().width;
  document.body.removeChild(tmp);
  btn.style.minWidth = Math.ceil(Math.max(w1,w2)) + "px";
  btn.style.textAlign='center';

  // IMPORTANT: role is assigned by the session/app state, not by this UI.
  // Keep the button as a label only (no toggling here).
  btn.dataset.role = (btn.textContent.trim().toLowerCase()==='host') ? 'host' : 'viewer';
  btn.title = 'Role is assigned by the session';
}

/* ---------- Username prefixing ---------- */
function syncNamePrefix(){
  const inp = qs('input[name="username"], #username');
  if(!inp) return;

  // Try to locate a stable user/client id from the app (best-effort)
  let userId = '';
  const idEl =
    qs('[data-client-id]') ||
    qs('[data-clientid]') ||
    qs('[data-peer-id]') ||
    qs('[data-peerid]');
  if(idEl){
    userId = (idEl.dataset.clientId || idEl.dataset.clientid || idEl.dataset.peerId || idEl.dataset.peerid || '').trim();
  }
  if(!userId){
    const any = qsa('[data-client-id],[data-peer-id]').find(Boolean);
    if(any) userId = (any.dataset.clientId || any.dataset.peerId || '').trim();
  }
  if(!userId) userId = 'UserID';

  const role = qs('.role-toggle-fixed')?.dataset.role || 'viewer';
  const prefix = role === 'host' ? '[HOST]' : '[VIEWER]';

  // Remove any existing role/id prefix to avoid stacking
  const cur = (inp.value||'');
  const stripped = cur.replace(/^\[(HOST|VIEWER)\]\[[^\]]+\]\s*/i,'').replace(/^\[(HOST|VIEWER)\]\s*/i,'');

  inp.value = `${prefix}[${userId}]${stripped}`;
}

/* ---------- Connection pill: simple label + rich tooltip ---------- */
function applyConnectionPill(){
  const pill = qs('[id*="connection"],[class*="connection"]');
  if(!pill) return;
  if(pill.dataset.patchedConn) return;
  pill.dataset.patchedConn="1";

  const obs = new MutationObserver(()=>{
    const full = pill.textContent.trim();
    pill.title = full;
    const lower = full.toLowerCase();
    if(lower.includes('connected')) pill.textContent='Connected';
    else if(lower.includes('connect')) pill.textContent='Connecting';
    else pill.textContent='Disconnected';
  });

  obs.observe(pill,{childList:true,subtree:true});
}

/* ---------- Join room typing ---------- */
function fixJoinInput(){
  const input = qs('#joinRoom, input[name="room"], input[placeholder*="Room"]');
  if(!input) return;
  if(input.dataset.patchedJoin) return;
  input.dataset.patchedJoin="1";
  input.removeAttribute('disabled');
  input.readOnly = false;
  input.style.pointerEvents='auto';
  input.style.userSelect='text';
}

/* ---------- Debugging: next-level features (throttled + scoped) ---------- */
const DEBUG = {
  paused: { log:false, err:false },
  filters: { level:'all', cats:new Set(), search:'' },
  counts: { errors:0, warnings:0 },
};

function ensureDebugUI(){
  const errs = qs('#dbgErrors');
  const logs = qs('#dbgLog');
  if(!errs || !logs) return;

  [errs, logs].forEach(box=>box.classList.add('dbg-scroll'));

  function addToolbar(box, kind){
    // NOTE: Element.closest() can return the element itself (e.g. because of the generic "div" selector).
    // If that happens, insertBefore(tb, box) would throw because "box" is not a child of itself.
    let container = box.closest('.card, .panel, section, div') || box.parentElement;
    if(container === box) container = box.parentElement;
    if(!container) return;
    // Do not inject debug toolbar into header/topbar
    if(container.closest && container.closest('header')) return;
    if(container.querySelector('.dbg-toolbar[data-kind="'+kind+'"]')) return;

    const tb = document.createElement('div');
    tb.className='dbg-toolbar';
    tb.dataset.kind = kind;

    tb.innerHTML = `
      <div class="dbg-left">
        <span class="dbg-label">${kind==='err'?'Errors':'Logs'}</span>
        <span class="dbg-badges">
          <span class="dbg-badge dbg-badge-err" title="Total errors">0</span>
          <span class="dbg-badge dbg-badge-warn" title="Total warnings">0</span>
        </span>
      </div>
      <div class="dbg-right">
        <div class="dbg-chips" role="group" aria-label="Filters">
          <button type="button" class="dbg-chip" data-level="all">All</button>
          <button type="button" class="dbg-chip" data-level="warn">Warn</button>
          <button type="button" class="dbg-chip" data-level="error">Error</button>
          <button type="button" class="dbg-chip" data-cat="rtc">RTC</button>
          <button type="button" class="dbg-chip" data-cat="signaling">Signaling</button>          <button type="button" class="dbg-chip" data-cat="ui">UI</button>
        </div>
        <input class="dbg-search" type="search" placeholder="Search…" aria-label="Search debugging text">
        <label class="dbg-pause"><input type="checkbox" class="dbg-pausecb"> Pause</label>
      </div>
    `;
    // Only insertBefore when box is actually a direct child; otherwise fall back safely.
    if(box.parentNode === container) container.insertBefore(tb, box);
    else container.prepend(tb);

    tb.addEventListener('click', (e)=>{
      const btn = e.target.closest('.dbg-chip');
      if(!btn) return;
      const level = btn.dataset.level;
      const cat = btn.dataset.cat;

      if(level){
        DEBUG.filters.level = level;
        qsa('.dbg-chip[data-level]', tb).forEach(b=>b.classList.toggle('active', b.dataset.level===level));
      } else if(cat){
        if(DEBUG.filters.cats.has(cat)) DEBUG.filters.cats.delete(cat);
        else DEBUG.filters.cats.add(cat);
        btn.classList.toggle('active', DEBUG.filters.cats.has(cat));
      }
      applyFilters();
    });

    const search = tb.querySelector('.dbg-search');
    search.addEventListener('input', ()=>{
      DEBUG.filters.search = (search.value||'').trim().toLowerCase();
      applyFilters();
    });

    const pauseCb = tb.querySelector('.dbg-pausecb');
    pauseCb.addEventListener('change', ()=>{
      if(kind==='log') DEBUG.paused.log = pauseCb.checked;
      else DEBUG.paused.err = pauseCb.checked;
    });

    box.addEventListener('scroll', ()=>{
      const atBottom = (box.scrollTop + box.clientHeight) >= (box.scrollHeight - 8);
      if(!atBottom){
        pauseCb.checked = true;
        if(kind==='log') DEBUG.paused.log = true; else DEBUG.paused.err = true;
      }
    }, {passive:true});

    qsa('.dbg-chip[data-level]', tb).forEach(b=>b.classList.toggle('active', b.dataset.level==='all'));
  }

  addToolbar(errs, 'err');
  addToolbar(logs, 'log');

  if(!qs('#dbgHeaderBadge')){
    const badge = document.createElement('span');
    badge.id='dbgHeaderBadge';
    badge.className='dbg-header-badge';
    badge.textContent='⚠ 0';
    const pill = qs('[id*="connection"],[class*="connection"]');
    if(pill && pill.parentElement) pill.parentElement.appendChild(badge);
    else (qs('header')||document.body).appendChild(badge);
  }
}

function updateCounters(){
  const errBadge = qs('.dbg-toolbar[data-kind="err"] .dbg-badge-err');
  const warnBadge = qs('.dbg-toolbar[data-kind="err"] .dbg-badge-warn');
  const headerBadge = qs('#dbgHeaderBadge');
  if(errBadge) errBadge.textContent = String(DEBUG.counts.errors);
  if(warnBadge) warnBadge.textContent = String(DEBUG.counts.warnings);
  if(headerBadge) headerBadge.textContent = `⚠ ${DEBUG.counts.errors}`;
}

function classifyLine(text){
  const t = (text||'').toLowerCase();
  const level =
    (t.includes(' js error') || t.includes('uncaught') || t.includes('error') || t.includes('failed')) ? 'error' :
    (t.includes('warn') || t.includes('warning') || t.includes('retry')) ? 'warn' :
    'info';

  let cat = 'ui';
  if(t.includes('webrtc') || t.includes('rtc') || t.includes('ice') || t.includes('sdp') || t.includes('rtp')) cat='rtc';
  else if(t.includes('signal') || t.includes('ws') || t.includes('websocket')) cat='signaling';
  return {level, cat};
}

function decorateNode(node){
  const text = (node.textContent||'').trim();
  if(!text) return;
  const {level, cat} = classifyLine(text);
  node.dataset.level = level;
  node.dataset.cat = cat;
  node.classList.add('dbg-line', 'dbg-'+level, 'dbg-cat-'+cat);
}

function autoscrollIfNeeded(box, kind){
  const paused = (kind==='log') ? DEBUG.paused.log : DEBUG.paused.err;
  if(paused) return;
  box.scrollTop = box.scrollHeight;
}

function applyFilters(){
  const search = DEBUG.filters.search;
  const level = DEBUG.filters.level;
  const cats = DEBUG.filters.cats;

  function applyToBox(sel){
    const box = qs(sel);
    if(!box) return;
    qsa('.dbg-line', box).forEach(line=>{
      const t = (line.textContent||'').toLowerCase();
      const okSearch = !search || t.includes(search);
      const okLevel = (level==='all') || (line.dataset.level===level);
      const okCat = (cats.size===0) || cats.has(line.dataset.cat);
      line.style.display = (okSearch && okLevel && okCat) ? '' : 'none';
    });
  }
  applyToBox('#dbgErrors');
  applyToBox('#dbgLog');
}

function wireObservers(){
  const errs = qs('#dbgErrors');
  const logs = qs('#dbgLog');
  if(!errs || !logs) return;

  if(!errs.dataset.obs){
    errs.dataset.obs="1";
    const obsE = new MutationObserver(muts=>{
      muts.forEach(m=>{
        m.addedNodes.forEach(n=>{
          if(n.nodeType!==1) return;
          decorateNode(n);
          n.classList.add('debug-flash');
          setTimeout(()=>n.classList.remove('debug-flash'), 900);
          if(n.dataset.level==='error') DEBUG.counts.errors += 1;
          else if(n.dataset.level==='warn') DEBUG.counts.warnings += 1;
          updateCounters();
          applyFilters();
          autoscrollIfNeeded(errs,'err');
        });
      });
    });
    obsE.observe(errs,{childList:true});
  }

  if(!logs.dataset.obs){
    logs.dataset.obs="1";
    const obsL = new MutationObserver(muts=>{
      muts.forEach(m=>{
        m.addedNodes.forEach(n=>{
          if(n.nodeType!==1) return;
          decorateNode(n);
          n.classList.add('debug-flash');
          setTimeout(()=>n.classList.remove('debug-flash'), 650);
          if(n.dataset.level==='error') DEBUG.counts.errors += 1;
          else if(n.dataset.level==='warn') DEBUG.counts.warnings += 1;
          updateCounters();
          applyFilters();
          autoscrollIfNeeded(logs,'log');
        });
      });
    });
    obsL.observe(logs,{childList:true});
  }

  // one-time decorate existing
  qsa('#dbgErrors > *').forEach(decorateNode);
  qsa('#dbgLog > *').forEach(decorateNode);
  applyFilters();
}

/* ---------- Throttled global observer ---------- */
/*
  The previous build froze because it re-ran applyAll for every log-line DOM mutation.
  Fix: debounce via requestAnimationFrame and ignore mutations inside dbgErrors/dbgLog.
*/
let scheduled = false;
function scheduleApply(){
  if(scheduled) return;
  scheduled = true;
  requestAnimationFrame(()=>{
    scheduled = false;
    applyAll();
  });
}

function applyAll(){
  applyRoleToggle();
  applyConnectionPill();
  fixJoinInput();
  ensureDebugUI();
  wireObservers();
}

const globalObserver = new MutationObserver((muts)=>{
  // Ignore frequent mutations from log streaming
  for(const m of muts){
    const t = m.target;
    if(t && t.closest && (t.closest('#dbgErrors') || t.closest('#dbgLog'))) continue;
    scheduleApply();
    break;
  }
});

function startGlobalObserver(){
  // Observe body, not entire documentElement, to reduce churn
  const root = document.body || document.documentElement;
  globalObserver.observe(root,{childList:true,subtree:true});
}

onReady(()=>{
  applyAll();
  startGlobalObserver();
});

// Keep username prefix synced
document.addEventListener('change', (e)=>{
  const el = e.target;
  if(el && (el.matches('input[name="username"]') || el.id==='username')) syncNamePrefix();
});

})();
</script>

<script>
/* Smooth <details> open/close (slide) */
(function(){
  const DURATION = 500;
  function setup(details){
    if(details.__pwSlideBound) return;
    details.__pwSlideBound = true;
    const summary = details.querySelector('summary');
    if(!summary) return;

    // Wrap remaining content in a container we can animate
    let content = details.querySelector(':scope > .pwDetailsContent');
    if(!content){
      content = document.createElement('div');
      content.className = 'pwDetailsContent';
      // Move all children except summary into content
      const kids = Array.from(details.children).filter(el => el !== summary);
      kids.forEach(el => content.appendChild(el));
      details.appendChild(content);
    }

    details.style.overflow = 'visible';
    content.style.overflow = details.open ? 'visible' : 'hidden';
    if(!details.open) { content.style.height = '0px'; }

    summary.addEventListener('click', (e)=>{
      // Let native toggle happen, but animate around it
      if(details.__pwAnimating) { e.preventDefault(); return; }
      const willOpen = !details.open;
      details.__pwAnimating = true;

      // Force start height
      const startH = content.getBoundingClientRect().height;
      if(willOpen){
      content.style.overflow = 'hidden';
      details.open = true;
        content.style.height = startH + 'px';
        // measure end
        const endH = content.scrollHeight;
        content.animate([{height: startH+'px'},{height:endH+'px'}],{duration:DURATION,easing:'ease'}).onfinish=()=>{
          content.style.height = '';
          content.style.overflow = 'visible';
          details.__pwAnimating = false;
        };
      }else{
        // Closing: clip content as height animates down (reverse of open)
        content.style.overflow = 'hidden';
        // Ensure we start from a fixed height so the animation actually clips.
        content.style.height = startH + 'px';
        const endH = 0;
        content.animate([{height: startH+'px'},{height:endH+'px'}],{duration:DURATION,easing:'ease'}).onfinish=()=>{
          details.open = false;
          content.style.height = '0px';
          content.style.overflow = 'hidden';
          details.__pwAnimating = false;
        };
      }
      e.preventDefault();
    });
  }

  function init(){
    document.querySelectorAll('details').forEach(setup);
  }
  if(document.readyState!=='loading') init();
  else document.addEventListener('DOMContentLoaded', init);
})();
</script>

    <script type="module" src="./app.js"></script>
</body>
</html>